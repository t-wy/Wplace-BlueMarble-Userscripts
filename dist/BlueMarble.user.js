// ==UserScript==
// @name         Blue Marble
// @namespace    https://github.com/SwingTheVine/
// @version      0.85.36
// @description  A userscript to automate and/or enhance the user experience on Wplace.live. Make sure to comply with the site's Terms of Service, and rules! This script is not affiliated with Wplace.live in any way, use at your own risk. This script is not affiliated with TamperMonkey. The author of this userscript is not responsible for any damages, issues, loss of data, or punishment that may occur as a result of using this script. This script is provided "as is" under the MPL-2.0 license. The "Blue Marble" icon is licensed under CC0 1.0 Universal (CC0 1.0) Public Domain Dedication. The image is owned by NASA.
// @author       SwingTheVine / TWY
// @license      MPL-2.0
// @supportURL   https://discord.gg/tpeBPy46hf
// @homepageURL  https://bluemarble.camilledaguin.fr/
// @icon         https://raw.githubusercontent.com/t-wy/Wplace-BlueMarble-Userscripts/36996586d068ed83800980ca8a8eb1be02af9752/dist/assets/Favicon.png
// @updateURL    https://raw.githubusercontent.com/t-wy/Wplace-BlueMarble-Userscripts/custom-improve/dist/BlueMarble.user.js
// @downloadURL  https://raw.githubusercontent.com/t-wy/Wplace-BlueMarble-Userscripts/custom-improve/dist/BlueMarble.user.js
// @match        https://wplace.live/*
// @run-at       document-start
// @grant        GM.addStyle
// @grant        GM.setValue
// @grant        GM.getValue
// ==/UserScript==

// Wplace  --> https://wplace.live
// License --> https://www.mozilla.org/en-US/MPL/2.0/

(()=>{var t,e,n=t=>{throw TypeError(t)},i=(t,e,i)=>e.has(t)?n("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(t):e.set(t,i),o=(t,e,i)=>(((t,e)=>{e.has(t)||n("Cannot access private method")})(t,e),i);function s(...t){(0,console.log)(...t)}function r(t){let e="";for(let n=0;n<t.length;n++)e+=String.fromCharCode(t[n]);return btoa(e)}function a(t){const e=atob(t),n=new Uint8Array(e.length);for(let t=0;t<e.length;t++)n[t]=e.charCodeAt(t);return n}window.OffscreenCanvas||(window.OffscreenCanvas=function(t,e){const n=document.createElement("canvas");return n.width=t,n.height=e,n.convertToBlob=function({type:t,i:e}={}){return new Promise((i,o)=>{n.toBlob(t=>{t?i(t):o(new Error("toBlob() returned null"))},t,e)})},n}),t=new WeakSet,e=function(t,e={},n={}){const i=document.createElement(t);this.o?(this.u?.appendChild(i),this.h.push(this.u),this.u=i):(this.o=i,this.u=i);for(const[t,n]of Object.entries(e))i[t]=n;for(const[t,e]of Object.entries(n))i[t]=e;return i};var l=[{id:0,premium:!1,name:"Transparent",rgb:[0,0,0]},{id:1,premium:!1,name:"Black",rgb:[0,0,0]},{id:2,premium:!1,name:"Dark Gray",rgb:[60,60,60]},{id:3,premium:!1,name:"Gray",rgb:[120,120,120]},{id:4,premium:!1,name:"Light Gray",rgb:[210,210,210]},{id:5,premium:!1,name:"White",rgb:[255,255,255]},{id:6,premium:!1,name:"Deep Red",rgb:[96,0,24]},{id:7,premium:!1,name:"Red",rgb:[237,28,36]},{id:8,premium:!1,name:"Orange",rgb:[255,127,39]},{id:9,premium:!1,name:"Gold",rgb:[246,170,9]},{id:10,premium:!1,name:"Yellow",rgb:[249,221,59]},{id:11,premium:!1,name:"Light Yellow",rgb:[255,250,188]},{id:12,premium:!1,name:"Dark Green",rgb:[14,185,104]},{id:13,premium:!1,name:"Green",rgb:[19,230,123]},{id:14,premium:!1,name:"Light Green",rgb:[135,255,94]},{id:15,premium:!1,name:"Dark Teal",rgb:[12,129,110]},{id:16,premium:!1,name:"Teal",rgb:[16,174,166]},{id:17,premium:!1,name:"Light Teal",rgb:[19,225,190]},{id:18,premium:!1,name:"Dark Blue",rgb:[40,80,158]},{id:19,premium:!1,name:"Blue",rgb:[64,147,228]},{id:20,premium:!1,name:"Cyan",rgb:[96,247,242]},{id:21,premium:!1,name:"Indigo",rgb:[107,80,246]},{id:22,premium:!1,name:"Light Indigo",rgb:[153,177,251]},{id:23,premium:!1,name:"Dark Purple",rgb:[120,12,153]},{id:24,premium:!1,name:"Purple",rgb:[170,56,185]},{id:25,premium:!1,name:"Light Purple",rgb:[224,159,249]},{id:26,premium:!1,name:"Dark Pink",rgb:[203,0,122]},{id:27,premium:!1,name:"Pink",rgb:[236,31,128]},{id:28,premium:!1,name:"Light Pink",rgb:[243,141,169]},{id:29,premium:!1,name:"Dark Brown",rgb:[104,70,52]},{id:30,premium:!1,name:"Brown",rgb:[149,104,42]},{id:31,premium:!1,name:"Beige",rgb:[248,178,119]},{id:32,premium:!0,name:"Medium Gray",rgb:[170,170,170]},{id:33,premium:!0,name:"Dark Red",rgb:[165,14,30]},{id:34,premium:!0,name:"Light Red",rgb:[250,128,114]},{id:35,premium:!0,name:"Dark Orange",rgb:[228,92,26]},{id:36,premium:!0,name:"Light Tan",rgb:[214,181,148]},{id:37,premium:!0,name:"Dark Goldenrod",rgb:[156,132,49]},{id:38,premium:!0,name:"Goldenrod",rgb:[197,173,49]},{id:39,premium:!0,name:"Light Goldenrod",rgb:[232,212,95]},{id:40,premium:!0,name:"Dark Olive",rgb:[74,107,58]},{id:41,premium:!0,name:"Olive",rgb:[90,148,74]},{id:42,premium:!0,name:"Light Olive",rgb:[132,197,115]},{id:43,premium:!0,name:"Dark Cyan",rgb:[15,121,159]},{id:44,premium:!0,name:"Light Cyan",rgb:[187,250,242]},{id:45,premium:!0,name:"Light Blue",rgb:[125,199,255]},{id:46,premium:!0,name:"Dark Indigo",rgb:[77,49,184]},{id:47,premium:!0,name:"Dark Slate Blue",rgb:[74,66,132]},{id:48,premium:!0,name:"Slate Blue",rgb:[122,113,196]},{id:49,premium:!0,name:"Light Slate Blue",rgb:[181,174,241]},{id:50,premium:!0,name:"Light Brown",rgb:[219,164,99]},{id:51,premium:!0,name:"Dark Beige",rgb:[209,128,81]},{id:52,premium:!0,name:"Light Beige",rgb:[255,197,165]},{id:53,premium:!0,name:"Dark Peach",rgb:[155,82,73]},{id:54,premium:!0,name:"Peach",rgb:[209,128,120]},{id:55,premium:!0,name:"Light Peach",rgb:[250,182,164]},{id:56,premium:!0,name:"Dark Tan",rgb:[123,99,82]},{id:57,premium:!0,name:"Tan",rgb:[156,132,107]},{id:58,premium:!0,name:"Dark Slate",rgb:[51,57,65]},{id:59,premium:!0,name:"Slate",rgb:[109,117,141]},{id:60,premium:!0,name:"Light Slate",rgb:[179,185,209]},{id:61,premium:!0,name:"Dark Stone",rgb:[109,100,63]},{id:62,premium:!0,name:"Stone",rgb:[148,140,107]},{id:63,premium:!0,name:"Light Stone",rgb:[205,197,158]}],c=new Map(l.filter(t=>Array.isArray(t?.rgb)).map(t=>[`${t.rgb[0]},${t.rgb[1]},${t.rgb[2]}`,{id:t.id,premium:!!t.premium,name:t.name}]));try{const t=l.find(t=>"transparent"===(t?.name||"").toLowerCase());t&&Array.isArray(t.rgb)&&c.set("222,250,206",{id:t.id,premium:!!t.premium,name:t.name})}catch(t){}try{c.set("other",{id:"other",premium:!1,name:"Other"})}catch(t){}function m(t,e){const n=(1e3*t[0]+e[0]+.5)/2048e3,i=1-(1e3*t[1]+e[1]+.5)/2048e3;return[360*Math.atan(Math.exp((2*i-1)*Math.PI))/Math.PI-90,360*n-180]}function d(t){t.width=0,t.height=0,t.constructor===HTMLCanvasElement&&t.remove(),t=null}function u(t,e,n=!0){const i=document.querySelector(".flex>.btn.btn-square.relative.shadow-md");let o=null;if(null!==i&&n)if(void 0!==i.__click){const t=null===i?null:i.__click[1].reactions[0].ctx.s.onlastpixelclick;o=(e,n)=>t({lat:e,lng:n})}else o=(t,e)=>{const n=document.createElement("script");n.setAttribute("bm-18",t),n.setAttribute("bm-19",e),n.textContent=`(${()=>{const t=document.currentScript,e=+t.getAttribute("bm-18"),n=+t.getAttribute("bm-19");document.querySelector(".flex>.btn.btn-square.relative.shadow-md").__click[1].reactions[0].ctx.s.onlastpixelclick({lat:e,lng:n})}})();`,document.documentElement?.appendChild(n),n.remove()};else{const t=document.querySelector(".right-3>button"),e=n?"flyTo":"jumpTo";if(null!==t)if(void 0!==t.__click){const n=t.__click[3].v;null!==n&&"string"==typeof n.version&&(o=(t,i)=>n[e]({center:[i,t],zoom:16}))}else o=(t,n)=>{const i=document.createElement("script");i.setAttribute("bm-18",t),i.setAttribute("bm-19",n),i.setAttribute("bm-X",e),i.textContent=`(${()=>{const t=document.currentScript,e=+t.getAttribute("bm-18"),n=+t.getAttribute("bm-19"),i=t.getAttribute("bm-X");document.querySelector(".right-3>button").__click[3].v[i]({center:[n,e],zoom:16})}})();`,document.documentElement?.appendChild(i),i.remove()}}if(null!==o)o(t,e);else{const n=`https://wplace.live/?lat=${t}&lng=${e}&zoom=14`;window.location.href=n}}function h(t,e,n=!0){const i=m(t,e);u(i[0],i[1],n)}function b(){return[[document.querySelector("#bm-Y")?.value||"",document.querySelector("#bm-Z")?.value||""],[document.querySelector("#bm--")?.value||"",document.querySelector("#bm-_")?.value||""]]}function p(){const t=b();return[[Number(t[0][0]),Number(t[0][1])],[Number(t[1][0]),Number(t[1][1])]]}function f(){const t=b(),e=p();return!(t.some(t=>t.some(t=>""===t))||e.some(t=>t.some(t=>isNaN(t)||t<0))||e[0][0]>2048||e[0][1]>2048||e[1][0]>1e3||e[1][1]>1e3)}var g={total:([t,e,n])=>n,painted:([t,e,n])=>e,remaining:([t,e,n])=>n-e,"painted%":([t,e,n])=>e/(0===n?1:n),hue:([t,e,n])=>{if("other"===t)return 361;if("#deface"===t)return-1;const[i,o,s]=t.split(",").map(Number),r=Math.max(i,o,s),a=r-Math.min(i,o,s);return 0===a?361+i:r===i?((o-s)/a+6)%6*60:r===o?60*((s-i)/a+2):60*((i-o)/a+4)},luminance:([t,e,n])=>{if("other"===t)return 2;if("#deface"===t)return 0;const[i,o,s]=t.split(",").map(Number);return(.2126*i+.7152*o+.0722*s)/255}};function v(t){if(navigator.clipboard&&"function"==typeof navigator.clipboard.writeText)navigator.clipboard.writeText(t);else{var e=document.createElement("textArea");e.innerHTML=t,document.body.appendChild(e),e.select(),document.execCommand("copy"),document.body.removeChild(e)}}function w(t,e){const n=[t[0][0]%2048*1e3+t[1][0]%1e3,e[0][0]%2048*1e3+e[1][0]%1e3],i=[t[0][1]%2048*1e3+t[1][1]%1e3,e[0][1]%2048*1e3+e[1][1]%1e3],o=Math.min(i[0],i[1]),s=Math.abs(i[0]-i[1])+1,r=Math.abs(n[0]-n[1])+1,a=2*r>2048e3;return[[a?Math.max(n[0],n[1]):Math.min(n[0],n[1]),o],[a?2048e3-r+2:r,s]]}function y(t,e){let n=new OffscreenCanvas(t,e);const i=n.getContext("2d");i.fillRect(t-1,e-1,1,1);const o=0!==i.getImageData(t-1,e-1,1,1).data[3];return d(n),n=null,o}function x(t,e){const n="https://backend.wplace.live/files/s0/tiles/"+t%2048+"/"+e+".png";return new Promise((t,e)=>{const i=new Image;i.crossOrigin="anonymous",i.onload=function(){t(i)},i.onerror=function(t){e(t)},i.src=n})}var $,M,C,k,S,T,D,O=class{constructor({displayName:t="My template",p:e=0,$:n="",url:i="",file:o=null,coords:s=null,M:r=null,C:a=null,k:l=1e3}={}){this.displayName=t,this.p=e,this.$=n,this.url=i,this.file=o,this.coords=s,this.M=r,this.C=a,this.k=l,this.enabled=!0,this.S=0,this.T=0,this.D=0,this.O={},this.L=new Set,this.N=null,this.B=Date.now().toString(),this.I=null}P(t,e,n){const i=n-1>>1;return(t%n==i||e%n==i)&&t%n>=i-1&&t%n<=i+1&&e%n>=i-1&&e%n<=i+1}j(t){const e=[];for(let n=0;n<t;n++)for(let i=0;i<t;i++)this.P(i,n,t)&&e.push([i,n]);return e}async R(t){null===this.I&&(this.I=y(5e3,5e3)?5:4);const e=this.I,n=await createImageBitmap(this.file,{colorSpaceConversion:"none"}),i=n.width,o=n.height,[s,a,l,m]=this.coords;let u=s*this.k+l,h=a*this.k+m;u-=Math.floor((i-1)*{l:0,m:.5,r:1}[t[0]]),h-=Math.floor((o-1)*{t:0,m:.5,b:1}[t[1]]),u<0&&(u+=2048*this.k),this.coords=[Math.floor(u/this.k),Math.floor(h/this.k),u%this.k,h%this.k];const b=i*o;this.S=b;try{let t=new OffscreenCanvas(i,o);const e=t.getContext("2d",{willReadFrequently:!0});e.imageSmoothingEnabled=!1,e.clearRect(0,0,i,o),e.drawImage(n,0,0);const s=e.getImageData(0,0,i,o).data;d(t),t=null;let r=0,a=0;const l=new Map;for(let t=0;t<o;t++)for(let e=0;e<i;e++){const n=4*(t*i+e),o=s[n],m=s[n+1],d=s[n+2];if(0===s[n+3])continue;222===o&&250===m&&206===d&&a++;const u=c.has(`${o},${m},${d}`)?`${o},${m},${d}`:"other";r++,l.set(u,(l.get(u)||0)+1)}this.T=r,this.D=a;const m={};for(const[t,e]of l.entries())m[t]={count:e,enabled:!0};this.O=m}catch(t){this.T=Math.max(0,this.S),this.D=0}const p={},f={};let g=new OffscreenCanvas(this.k,this.k);const v=g.getContext("2d",{willReadFrequently:!0});for(let t=this.coords[3];t<o+this.coords[3];){const s=Math.min(this.k-t%this.k,o+this.coords[3]-t);for(let o=this.coords[2];o<i+this.coords[2];){const a=Math.min(this.k-o%this.k,i+this.coords[2]-o),l=a*e,c=s*e;g.width=l,g.height=c,v.imageSmoothingEnabled=!1,v.clearRect(0,0,l,c),v.drawImage(n,o-this.coords[2],t-this.coords[3],a,s,0,0,a*e,s*e);const m=v.getImageData(0,0,l,c);for(let t=0;t<c;t++)for(let n=0;n<l;n++){const i=4*(t*l+n);222===m.data[i]&&250===m.data[i+1]&&206===m.data[i+2]?((n+t)%2==0?(m.data[i]=0,m.data[i+1]=0,m.data[i+2]=0):(m.data[i]=255,m.data[i+1]=255,m.data[i+2]=255),m.data[i+3]=32):this.P(n,t,e)||(m.data[i+3]=0)}v.putImageData(m,0,0);const d=`${(this.coords[0]+Math.floor(o/this.k)).toString().padStart(4,"0")},${(this.coords[1]+Math.floor(t/this.k)).toString().padStart(4,"0")},${(o%this.k).toString().padStart(3,"0")},${(t%this.k).toString().padStart(3,"0")}`;p[d]=await createImageBitmap(g),this.L.add(d.split(",").slice(0,2).join(","));const u=await g.convertToBlob(),h=await u.arrayBuffer(),b=Array.from(new Uint8Array(h));f[d]=r(b),o+=a}t+=s}return n.close(),d(g),g=null,{F:p,A:f}}async H(t,e=!1){if(void 0===this.M[t])return;if(null!==this.M[t])return this.M[t];const n=new Blob([this.C[t]],{type:"image/png"}),i=await createImageBitmap(n);return!1===e&&(this.M[t]=i),i}};$=new WeakSet,M=async function(t){const e=t.templates,n=this.U();if(Object.keys(e).length>0){for(const t in e){const i=t,o=e[t],s=o.coords.split(",").map(Number);if(e.hasOwnProperty(t)){const t=i.split(" "),r=Number(t?.[0]),l=t?.[1]||"0",c=o.name||`Template ${r||""}`,m=o.tiles,u={},h={};let b=0;const p=new Map;for(const t in m)if(m.hasOwnProperty(t)){const o=a(m[t]),s=new Blob([o],{type:"image/png"}),r=await createImageBitmap(s);u[t]=n?null:r,h[t]=o;try{const t=r.width,n=r.height;let o=new OffscreenCanvas(t,n);const s=o.getContext("2d",{willReadFrequently:!0});s.imageSmoothingEnabled=!1,s.clearRect(0,0,t,n),s.drawImage(r,0,0);const a=s.getImageData(0,0,t,n).data;d(o),o=null;for(let o=this.q;o<n;o+=this.G)for(let n=this.q;n<t;n+=this.G){const s=4*(o*t+n),r=a[s],l=a[s+1],c=a[s+2];if(a[s+3]<64)continue;if(222===r&&250===l&&206===c)continue;b++;const m=Object.hasOwn(e[i].palette,`${r},${l},${c}`)?`${r},${l},${c}`:"other";p.set(m,(p.get(m)||0)+1)}}catch(t){}n&&r.close()}const f=new O({displayName:c,p:r||this.J+1||0,$:l||"",coords:s});f.p>this.J&&(this.J=f.p),f.I=this.G,f.M=u,f.C=h,f.T=b,f.enabled=o.enabled??!0;const g={};for(const[t,e]of p.entries())g[t]={count:e,enabled:!0};f.O=g;try{Object.keys(u).forEach(t=>{f.L?.add(t.split(",").slice(0,2).join(","))})}catch(t){}try{const t=e?.[i]?.palette;if(t)for(const[e,n]of Object.entries(t))f.O[e]?f.O[e].enabled=!!n?.enabled:f.O[e]={count:n?.count||0,enabled:!!n?.enabled}}catch(t){}f.N=i,this.Y.push(f)}}try{window.postMessage({source:"blue-marble",X:"bm-m"},"*")}catch(t){}try{window.postMessage({source:"blue-marble",X:"bm-b"},"*")}catch(t){}}},C=new WeakSet,k=function(){o(this,C,S).call(this),this._=setInterval(()=>{o(this,C,S).call(this)},1e3)},S=function(){if(null===this.charges&&(o(this,C,T).call(this),null===this.charges))return;const t=Math.floor(this.W()),e=this.charges.max,n=(new Intl.NumberFormat).format(t),i=(new Intl.NumberFormat).format(e),s=document.getElementById("bm-Q"),r=s?.querySelector('[data-role="countdown"]'),a=s?.querySelector('[data-role="charge-count"]');s&&r&&a&&(r.textContent=this.V(),a.textContent=`(${n} / ${i})`)},T=function(){const t=document.querySelector(".relative>.dropdown>.dropdown-content>section>button.btn");if(null===t)return null;if(void 0!==t.__click&&void 0!==t.__click[2]){const e=t.__click[2]?.user,n=JSON.parse(JSON.stringify(e?.data??null)),i=e?.lastFetch??null;o(this,C,D).call(this,n??null,i?+i:null)}else{const t=()=>{const t=document.currentScript,e=document.querySelector(".relative>.dropdown>.dropdown-content>section>button.btn"),n=e.__click?.[2]?.user;t.setAttribute("bm-12",JSON.stringify(n?.data??null)),t.setAttribute("bm-V",JSON.stringify(n?.lastFetch??null))},e=document.createElement("script");e.textContent=`(${t})();`,document.documentElement?.appendChild(e);const n=JSON.parse(e.getAttribute("bm-12")),i=JSON.parse(e.getAttribute("bm-V"));e.remove(),o(this,C,D).call(this,n??null,i?+i:null)}},D=function(t,e){if(null===t)return;const n=Math.ceil(Math.pow(Math.floor(t.level)*Math.pow(30,.65),1/.65)-t.pixelsPainted);t.id||t.id,this.Z.K=t.id,this.charges=t.charges,this.tt=e,this.Z.et(t.extraColorsBitmap??0);const i=document.getElementById("bm-W");i&&(i.textContent=t.name);const o=document.getElementById("bm-K");o&&(o.textContent=(new Intl.NumberFormat).format(t.droplets));const s=document.getElementById("bm-C"),r=document.getElementById("bm-c");s&&r&&(s.textContent=(new Intl.NumberFormat).format(n),r.textContent=1==n?"":"s");const a=document.getElementById("bm-D");a&&(a.textContent=Math.floor(t.level)+1)};var L=GM_info.script.name.toString(),E=GM_info.script.version.toString();!function(t){const e=document.createElement("script");e.setAttribute("bm-16",L),e.setAttribute("bm-13","color: cornflowerblue;"),e.textContent=`(${t})();`,document.documentElement?.appendChild(e),e.remove()}(()=>{const t=document.currentScript,e=t?.getAttribute("bm-16")||"Blue Marble",n=t?.getAttribute("bm-13")||"",i=new Map;window.addEventListener("message",t=>{const{source:o,endpoint:s,blobID:r,blobData:a,blink:l}=t.data;if(Date.now(),"blue-marble"==o&&r&&a&&!s){const t=i.get(r);"function"==typeof t?t(a):function(...t){(0,console.warn)(...t)}(`%c${e}%c: Attempted to retrieve a blob (%s) from queue, but the blobID was not a function! Skipping...`,n,"",r),i.delete(r)}});const o=window.fetch;window.fetch=async function(...t){const e=await o.apply(this,t),n=e.clone(),s=(t[0]instanceof Request?t[0]?.url:t[0])||"ignore",r=n.headers.get("content-type")||"";if(r.includes("application/json")){const t=Date.now();n.json().then(e=>{window.postMessage({source:"blue-marble",endpoint:s,jsonData:e,blink:t},"*")}).catch(t=>{})}else if(r.includes("image/")&&!s.includes("openfreemap")&&!s.includes("maps")){const t=Date.now(),e=await n.blob();return new Promise(o=>{const r=crypto.randomUUID();i.set(r,t=>{const e=new Response(t,{headers:n.headers,status:n.status,statusText:n.statusText});t instanceof ImageBitmap&&(e.arrayBuffer=()=>t),o(e)}),window.postMessage({source:"blue-marble",endpoint:s,lastModified:n.headers.get("Last-Modified"),blobID:r,blobData:e,blink:t})}).catch(t=>{Date.now()})}return e}}),GM.addStyle("#bm-11{position:fixed;background-color:#153063cc;color:#fff;padding:10px;border-radius:8px;z-index:9000;transition:all .3s ease,transform 0s;max-width:300px;width:auto;will-change:transform;backface-visibility:hidden;-webkit-backface-visibility:hidden;transform-style:preserve-3d;-webkit-transform-style:preserve-3d}#bm-u,#bm-11 hr,#bm-o,#bm-8{transition:opacity .2s ease,height .2s ease}div#bm-11{font-family:ui-sans-serif,system-ui,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Monaco,DejaVu Sans,sans-serif;letter-spacing:.05em}#bm-10{margin-bottom:.5em;background:url('data:image/svg+xml;utf8,<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"5\" height=\"5\"><circle cx=\"3\" cy=\"3\" r=\"1.5\" fill=\"CornflowerBlue\" /></svg>') repeat;cursor:grab;width:100%;height:1em}#bm-10.dragging{cursor:grabbing}#bm-11:has(#bm-10.dragging){pointer-events:none;user-select:none;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none}#bm-10.dragging{pointer-events:auto}#bm-E{margin-bottom:.5em}#bm-E[style*=\"text-align: center\"]{display:flex;flex-direction:column;align-items:center;justify-content:center}#bm-11[style*=\"padding: 5px\"]{width:auto!important;max-width:300px;min-width:200px}#bm-11 img{display:inline-block;height:2.5em;margin-right:1ch;vertical-align:middle;transition:opacity .2s ease}#bm-E[style*=\"text-align: center\"] img{display:block;margin:0 auto}#bm-10{transition:margin-bottom .2s ease}#bm-11 h1{display:inline-block;font-size:x-large;font-weight:700;vertical-align:middle}#bm-o input[type=checkbox]{vertical-align:middle}#bm-o label>input[type=checkbox]{margin-right:.5ch}#bm-o label{margin-right:.5ch}.bm-17{border:white 1px solid;height:1.5em;width:1.5em;margin-top:2px;text-align:center;line-height:1em;padding:0!important}#bm-M{vertical-align:middle}#bm-M svg{width:50%;margin:0 auto;fill:#111}div:has(>#bm-A){display:flex;gap:.5ch}#bm-button-favorite svg,#bm-button-template svg{height:1em;margin:2px auto 0;text-align:center;line-height:1em;vertical-align:bottom}#bm-F input[type=number]{appearance:auto;-moz-appearance:textfield;width:5.5ch;margin-left:1ch;background-color:#0003;padding:0 .5ch;font-size:small}#bm-F input[type=number]::-webkit-outer-spin-button,#bm-F input[type=number]::-webkit-inner-spin-button{-webkit-appearance:none;margin:0}#bm-4{white-space:nowrap;text-align:center}#bm-6{display:flex;flex-direction:row;flex-wrap:wrap;align-content:center;justify-content:center;align-items:center;gap:1ch}div:has(>#bm-k)>button{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}#bm-k,input[type=file][id*=template]{display:none!important;visibility:hidden!important;position:absolute!important;left:-9999px!important;top:-9999px!important;width:0!important;height:0!important;opacity:0!important;z-index:-9999!important;pointer-events:none!important}#bm-L{font-size:small;background-color:#0003;padding:0 .5ch;height:3.75em;width:100%}#bm-8{display:flex;justify-content:space-between}#bm-11 small{font-size:x-small;color:#d3d3d3}#bm-u,#bm-o,#bm-F,#bm-6,#bm-L{margin-top:.5em}#bm-Q{display:flex;align-items:baseline;gap:.5ch;white-space:nowrap;min-height:1.4em}#bm-Q .bm-v{color:orange;font-weight:700;font-variant-numeric:tabular-nums;font-feature-settings:\"tnum\"}#bm-Q .bm-R{color:#d3d3d3;font-size:.8em}#bm-11 button{background-color:#144eb9;border-radius:1em;padding:0 .75ch;font-size:small}#bm-11 span:has(>input[type=file]+button){font-size:small}#bm-11 select{border-width:1px;border-radius:1em;padding:0 .75ch;font-size:small}#bm-11 select option{background-color:#153063cc}#bm-11 button:hover,#bm-11 button:focus-visible{background-color:#1061e5}#bm-11 button:active #bm-11 button:disabled{background-color:#2e97ff}#bm-11 button:disabled{text-decoration:line-through}#bm-11 details>summary{font-size:small}\n");var N=new class{constructor(e,n){i(this,t),this.name=e,this.version=n,this.nt=null,this.it="bm-L",this.o=null,this.u=null,this.h=[]}ot(t){this.nt=t}st(){return this.h.length>0&&(this.u=this.h.pop()),this}ct(t){t?.appendChild(this.o),this.o=null,this.u=null,this.h=[]}dt(n={},i=()=>{}){return i(this,o(this,t,e).call(this,"div",{},n)),this}ut(n={},i=()=>{}){return i(this,o(this,t,e).call(this,"p",{},n)),this}ht(n={},i=()=>{}){return i(this,o(this,t,e).call(this,"span",{},n)),this}bt(n={},i=()=>{}){return i(this,o(this,t,e).call(this,"b",{},n)),this}ft(t){if(!this.o)return this;const e=document.createTextNode(t);return this.u?.appendChild(e),this}gt(n={},i=()=>{}){return i(this,o(this,t,e).call(this,"small",{},n)),this}vt(n={},i=()=>{}){return i(this,o(this,t,e).call(this,"img",{},n)),this}wt(n,i={},s=()=>{}){return s(this,o(this,t,e).call(this,"h"+n,{},i)),this}yt(n={},i=()=>{}){return i(this,o(this,t,e).call(this,"hr",{},n)),this}xt(n={},i=()=>{}){return i(this,o(this,t,e).call(this,"br",{},n)),this}$t(n={},i=()=>{}){const s=o(this,t,e).call(this,"label",{textContent:n.textContent??""});delete n.textContent;const r=o(this,t,e).call(this,"input",{type:"checkbox"},n);return s.insertBefore(r,s.firstChild),this.st(),i(this,s,r),this}Mt(n={},i=()=>{}){const s=n.textContent;delete n.textContent;const r=o(this,t,e).call(this,"details",{type:"details"},n),a=o(this,t,e).call(this,"summary",{textContent:s??""});return r.appendChild(a),this.st(),i(this,a,r),this}Ct(n={},i=()=>{}){return i(this,o(this,t,e).call(this,"button",{},n)),this}kt(n={},i=()=>{}){const s=n.title??n.textContent??"Help: No info";delete n.textContent,n.title=`Help: ${s}`;const r={textContent:"?",className:"bm-17",onclick:()=>{this.St(this.it,s)}};return i(this,o(this,t,e).call(this,"button",r,n)),this}Tt(n={},i=()=>{}){return i(this,o(this,t,e).call(this,"select",{},n)),this}Dt(n={},i=()=>{}){return i(this,o(this,t,e).call(this,"input",{},n)),this}Ot(n={},i=()=>{}){const s=n.textContent??"";delete n.textContent;const r=o(this,t,e).call(this,"span"),a=o(this,t,e).call(this,"input",{type:"file",style:"display: none !important; visibility: hidden !important; position: absolute !important; left: -9999px !important; width: 0 !important; height: 0 !important; opacity: 0 !important;"},n);this.st();const l=o(this,t,e).call(this,"button",{textContent:s});return this.st(),this.st(),a.setAttribute("tabindex","-1"),a.setAttribute("aria-hidden","true"),l.addEventListener("click",()=>{a.click()}),a.addEventListener("change",()=>{l.style.maxWidth=`${l.offsetWidth}px`,a.files.length>0?l.textContent=a.files[0].name:l.textContent=s}),i(this,r,a,l),this}Lt(n={},i=()=>{}){return i(this,o(this,t,e).call(this,"textarea",{},n)),this}St(t,e,n=!1){const i=document.getElementById(t.replace(/^#/,""));i&&(i instanceof HTMLInputElement?i.value=e:n?i.textContent=e:i.innerHTML=e)}Et(t,e){let n,i=!1,o=0,s=null,r=0,a=0,l=0,c=0;if(t=document.querySelector("#"==t?.[0]?t:"#"+t),e=document.querySelector("#"==e?.[0]?e:"#"+e),!t||!e)return void this.Nt(`Can not drag! ${t?"":"moveMe"} ${t||e?"":"and "}${e?"":"iMoveThings "}was not found!`);const m=()=>{if(i){const e=Math.abs(r-l),n=Math.abs(a-c);(e>.5||n>.5)&&(r=l,a=c,t.style.transform=`translate(${r}px, ${a}px)`,t.style.left="0px",t.style.top="0px",t.style.right=""),s=requestAnimationFrame(m)}};let d=null;const u=(u,h)=>{i=!0,d=t.getBoundingClientRect(),n=u-d.left,o=h-d.top;const b=window.getComputedStyle(t).transform;if(b&&"none"!==b){const t=new DOMMatrix(b);r=t.m41,a=t.m42}else r=d.left,a=d.top;l=r,c=a,document.body.style.userSelect="none",e.classList.add("dragging"),s&&cancelAnimationFrame(s),m()},h=()=>{i=!1,s&&(cancelAnimationFrame(s),s=null),document.body.style.userSelect="",e.classList.remove("dragging")};e.addEventListener("mousedown",function(t){t.preventDefault(),u(t.clientX,t.clientY)}),e.addEventListener("touchstart",function(t){const e=t?.touches?.[0];e&&(u(e.clientX,e.clientY),t.preventDefault())},{passive:!1}),document.addEventListener("mousemove",function(t){i&&d&&(l=t.clientX-n,c=t.clientY-o)},{passive:!0}),document.addEventListener("touchmove",function(t){if(i&&d){const e=t?.touches?.[0];if(!e)return;l=e.clientX-n,c=e.clientY-o,t.preventDefault()}},{passive:!1}),document.addEventListener("mouseup",h),document.addEventListener("touchend",h),document.addEventListener("touchcancel",h)}Bt(t){(0,console.info)(`${this.name}: ${t}`),this.St(this.it,"Status: "+t,!0)}Nt(t){(0,console.error)(`${this.name}: ${t}`),this.St(this.it,"Error: "+t,!0)}}(L,E),B=new class{constructor(t,e,n){i(this,$),this.name=t,this.version=e,this.o=n,this.It="1.0.0",this.K=null,this.Pt="!#$%&'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[]^_`abcdefghijklmnopqrstuvwxyz{|}~",this.k=1e3,this.G=y(5e3,5e3)?5:4,this.q=this.G-1>>1,this.jt=null,this.Rt=null,this.Ft="bm-14",this.At="div#map canvas.maplibregl-canvas",this.Ht=null,this.Y=[],this.Ut=null,this.qt=new Map,this.extraColorsBitmap=0,this.zt={},this.hideLockedColors=!1,this.J=0}Gt(){if(document.body.contains(this.jt))return this.jt;document.getElementById(this.Ft)?.remove();const t=document.querySelector(this.At),e=document.createElement("canvas");return e.id=this.Ft,e.className="maplibregl-canvas",e.style.position="absolute",e.style.top="0",e.style.left="0",e.style.height=t?.clientHeight*(window.devicePixelRatio||1)+"px",e.style.width=t?.clientWidth*(window.devicePixelRatio||1)+"px",e.height=t?.clientHeight*(window.devicePixelRatio||1),e.width=t?.clientWidth*(window.devicePixelRatio||1),e.style.zIndex="8999",e.style.pointerEvents="none",t?.parentElement?.appendChild(e),this.jt=e,window.addEventListener("move",this.Jt),window.addEventListener("zoom",this.Yt),window.addEventListener("resize",this.Xt),this.jt}async _t(){return{whoami:this.name.replace(" ",""),scriptVersion:this.version,schemaVersion:this.It,templates:{}}}async Wt(t,e,n){this.Ut||(this.Ut=await this._t()),this.o.Bt(`Creating template at ${n.join(", ")}...`);const i=function(t,e){if(0===t)return e[0];let n="";const i=e.length;for(;t>0;)n=e[t%i]+n,t=Math.floor(t/i);return n}(this.K||0,this.Pt),o=new O({displayName:e,p:this.J+1,$:i,file:t,coords:n,k:this.k});this.J++,o.I=this.G;const{F:s,A:r}=await o.R(this.Vt()),l=this.Kt();for(const t of Object.keys(o.O))void 0!==l[t]&&(o.O[t].enabled=l[t]);this.U()?(o.M={},Object.entries(s).forEach(([t,e])=>{o.M[t]=null,e.close()})):o.M=s,o.C=Object.fromEntries(Object.entries(r).map(([t,e])=>[t,a(e)]));const c=`${o.p} ${o.$}`;o.N=c,this.Ut.templates[c]={name:o.displayName,coords:n.join(", "),enabled:!0,tiles:r,palette:o.O},this.Y.push(o),this.Zt(o);const m=(new Intl.NumberFormat).format(o.S);this.o.Bt(`Template created at ${n.join(", ")}! Total pixels: ${m}`),this.Qt(),await this.te()}Qt(){try{window.postMessage({source:"blue-marble",X:"bm-m"},"*")}catch(t){}try{window.postMessage({source:"blue-marble",X:"bm-b"},"*")}catch(t){}}ee(){if(this.ne())try{const t=document.querySelector("#bm-r");t&&(t.style.display=""),window.postMessage({source:"blue-marble",X:"bm-n"},"*")}catch(t){}}async te(){await GM.setValue("bmTemplates",JSON.stringify(this.Ut))}async ie(t){const e=this.Y.find(e=>e.N===t);if(void 0===e)return;const n=this.Y.indexOf(e);this.Y.splice(n,1);const i=this.Ut?.templates;i&&i?.[t]&&delete i[t],this.Zt(e),this.o.Bt(`Template ${e.displayName} is deleted!`),await this.te(),this.Qt()}async oe(){this.Ut||(this.Ut=await this._t())}async se(t,e){performance.now();const n=e[0].toString().padStart(4,"0")+","+e[1].toString().padStart(4,"0"),i=this.re(e);if(0===i.length)return t;const o=this.U(),s=i.map(t=>{const e=Object.keys(t.M).filter(t=>t.startsWith(n));if(0===e.length)return null;const i=e[0],o=i.split(",");return{Ht:t,ae:i,le:[+o[0],+o[1]],ce:[+o[2],+o[3]]}}).filter(Boolean),r=s?.length||0,a=this.Y.filter(t=>t.enabled).length;let l=0,m=0,u=0,h={},b={};const p=await createImageBitmap(t),f=this.Kt(),g=this.me(),v=new Set(g),w=g.length!==Object(f).length,y=0===g.length,x=!(0===s.length||y),$=this.k*this.G;let M=new OffscreenCanvas($,$);const C=M.getContext("2d");C.imageSmoothingEnabled=!1,C.beginPath(),C.rect(0,0,$,$),C.clip(),C.clearRect(0,0,$,$),C.drawImage(p,0,0,$,$),p.close();let k=null;try{k=C.getImageData(0,0,$,$).data}catch(t){}for(const t of s){const n=t.Ht.N,i=await t.Ht.H(t.ae,o);if(k)try{const o=i.width,s=i.height;let r=new OffscreenCanvas(o,s);const a=r.getContext("2d",{willReadFrequently:!0});a.imageSmoothingEnabled=!1,a.clearRect(0,0,o,s),a.drawImage(i,0,0);const p=a.getImageData(0,0,o,s).data;d(r),r=null;const f=t.ce[0]*this.G,g=t.ce[1]*this.G;for(let i=this.q;i<s;i+=this.G)for(let s=this.q;s<o;s+=this.G){const r=s+f,a=i+g;if(r<0||a<0||r>=$||a>=$)continue;const d=4*(i*o+s),v=p[d],w=p[d+1],y=p[d+2];if(p[d+3]<64){try{const t=4*(a*$+r),e=k[t],n=k[t+1],i=k[t+2],o=k[t+3];c.has(`${e},${n},${i}`),o>=64&&m++}catch(t){}continue}u++;const x=4*(a*$+r),M=k[x],C=k[x+1],S=k[x+2],T=k[x+3];let D=!1;if(T<64);else if(M===v&&C===w&&S===y){l++,D=!0;let e=`${v},${w},${y}`;c.has(e)||(e="other"),void 0===h[e]?h[e]={painted:1,de:+(t.Ht.enabled??!0),ue:0,he:[],be:[]}:(h[e].painted++,(t.Ht.enabled??1)&&h[e].de++),void 0===b[n]?b[n]={painted:1}:b[n].painted++}else m++;if(!D){let n=`${v},${w},${y}`;c.has(n)||(n="other");const i=[e,[Math.floor(r/this.G),Math.floor(a/this.G)]];if(void 0===h[n])h[n]={painted:0,de:0,ue:1,he:[i],be:[]},(t.Ht.enabled??1)&&h[n].be.push(i);else{const e=this.zt?.smartPlace?1<<20:100;if(h[n].ue++,h[n].he.length<e)h[n].he.push(i);else if(Math.random()*h[n].he.length<e){const t=Math.floor(Math.random()*e);h[n].he[t]=i}if(t.Ht.enabled??1)if(h[n].be.length<e)h[n].be.push(i);else if(Math.random()*h[n].be.length<e){const t=Math.floor(Math.random()*e);h[n].be[t]=i}}}}}catch(t){}if(t.Ht.enabled??1){const e=t.ce[0]*this.G,n=t.ce[1]*this.G;try{if(w){if(!y){const o=i.width,s=i.height;let r=new OffscreenCanvas(o,s);const a=r.getContext("2d",{willReadFrequently:!0});a.imageSmoothingEnabled=!1,a.clearRect(0,0,o,s),a.drawImage(i,0,0);const l=a.getImageData(0,0,o,s),m=l.data;for(const[e,n]of t.Ht.j(this.G))for(let t=n;t<s;t+=this.G)for(let n=e;n<o;n+=this.G){const e=4*(t*o+n),i=m[e],s=m[e+1],r=m[e+2];if(m[e+3]<1)continue;let a=`${i},${s},${r}`;c.has(`${i},${s},${r}`)||(a="other"),v.has(a)||(m[e+3]=0)}a.putImageData(l,0,0),C.drawImage(r,e,n),d(r),r=null}}else C.drawImage(i,e,n)}catch(t){C.drawImage(i,e,n)}}o&&i.close()}0===r?this.qt.has(n)&&this.qt.delete(n):this.qt.set(n,{painted:l,required:u,pe:m,palette:h,Ht:b});let S=0,T=0,D=0;for(const t of this.qt.values())S+=t.painted||0,T+=t.required||0,D+=t.pe||0;const O=this.Y.reduce((t,e)=>t+(e.T||e.S||0),0),L=O>0?O:T,E=(new Intl.NumberFormat).format(S),N=(new Intl.NumberFormat).format(L),B=(new Intl.NumberFormat).format(L-S);this.o.Bt(`Displaying ${a} template${1==a?"":"s"}.\nPainted ${E} / ${N} • Wrong ${B}`);const I=x?await M.convertToBlob({type:"image/png"}):t;return d(M),window.buildColorFilterList(),window.buildTemplateFilterList(),I}fe(t){"BlueMarble"==t?.whoami&&(this.Ut=t,o(this,$,M).call(this,t))}Kt(){const t={};for(const e of this.Y)for(const[n,i]of Object.entries(e.O))t[n]||(t[n]=i.enabled);return t}me(){const t=this.Kt(),e=this.ge(),n=[];return Object.entries(t).forEach(([t,i])=>{i&&(e&&!this.ve(c.get(t).id)||n.push(t))}),n.sort()}re(t){const e=t[0].toString().padStart(4,"0")+","+t[1].toString().padStart(4,"0");return this.Y.filter(t=>!!t?.M&&(t.L&&t.L.size>0?t.L.has(e):Object.keys(t.M).some(t=>t.startsWith(e)))).sort((t,e)=>t.p-e.p)}we(t){const e=this.me(),n=this.re(t);return this.ye(e,n)}ye(t,e){return t.join(";")+"||"+e.map(t=>t.N+","+t.B+","+ +(t.enabled??!0)).join(";")}async xe(){await GM.setValue("bmUserSettings",JSON.stringify(this.zt))}$e(t){this.zt=t}ge(){return this.zt?.hideLockedColors??!1}async Me(t){this.zt.hideLockedColors=t,await this.xe()}Ce(){const t=this.zt?.sortBy??"total-desc";return this.ke(t)?t:"total-desc"}ke(t){const e=t.toLowerCase().split("-");return 2===e.length&&void 0!==g[e[0]]&&!!["desc","asc"].includes(e[1])}async Se(t){return!!this.ke(t)&&(this.zt.sortBy=t.toLowerCase(),await this.xe(),!0)}Te(){return this.zt?.progressBarEnabled??!0}async De(t){this.zt.progressBarEnabled=t,await this.xe()}Oe(){return this.zt?.hideCompletedColors??!1}async Le(t){this.zt.hideCompletedColors=t,await this.xe()}U(){return this.zt?.memorySavingMode??!1}async Ee(t){this.zt.memorySavingMode=t,await this.xe(),t||this.Y.forEach(t=>{if(!t?.M)return;const e=t.M,n={};Object.entries(e).forEach(([t,e])=>{n[t]=null,null!==e&&e.close()}),t.M=n})}Vt(){const t=this.zt?.anchor??"lt";return this.Ne(t)?t.toLowerCase():"lt"}Ne(t){return 2===t.length&&(t=t.toLowerCase(),"lmr".includes(t[0])&&"tmb".includes(t[1]))}async Be(t){return!!this.Ne(t)&&(this.zt.anchor=t.toLowerCase(),await this.xe(),!0)}ne(){return this.zt?.eventEnabled??!1}async Ie(t){this.zt.eventEnabled=t,await this.xe()}Pe(){return this.zt?.eventClaimedShown??!0}async je(t){this.zt.eventClaimedShown=t,await this.xe()}Re(){return this.zt?.eventUnavailableShown??!0}async Fe(t){this.zt.eventUnavailableShown=t,await this.xe()}Ae(){return this.zt?.eventProvider??""}async He(t){this.zt.eventProvider=t,await this.xe()}et(t){this.extraColorsBitmap!==t&&(this.extraColorsBitmap=t,window.buildColorFilterList())}ve(t){if(t<32)return!0;const e=1<<t-32;return 0!==(this.extraColorsBitmap&e)}Zt(t){t.L.forEach(t=>{this.qt.delete(t)})}}(L,E,N),I=new class{constructor(t){i(this,C),this.Z=t,this.Ue=!1,this.qe=[],this.ze=[],this.charges=null,this.tt=null,this._=null,this.Ge={},this.Je=null}W(){if(null===this.charges&&(o(this,C,T).call(this),null===this.charges))return 0;const t=(Date.now()-this.tt)/this.charges.cooldownMs,e=this.charges.count+t,n=this.charges.count>this.charges.max?this.charges.count:this.charges.max;return e>n?n:e}Ye(){const t=this.W();return t>=this.charges.max?0:(this.charges.max-t)*this.charges.cooldownMs}V(){const t=this.Ye();if(0===t)return"00:00";const e=Math.floor(t/1e3),n=Math.floor(e/3600),i=Math.floor(e%3600/60).toString().padStart(2,"0"),o=(e%60).toString().padStart(2,"0");return n>0?`${n}:${i}:${o}`:`${i}:${o}`}Xe(){const t=[this.qe[0],this.qe[1]],e=[this.qe[2],this.qe[3]],n=(i=t,o=e,[parseInt(i[0])%4*1e3+parseInt(o[0]),parseInt(i[1])%4*1e3+parseInt(o[1])]);var i,o;const s=document.querySelectorAll("span");for(const i of s)if(i.textContent.trim().includes(`${n[0]}, ${n[1]}`)){let n=document.getElementById("bm-x"),o=document.getElementById("bm-y"),s=document.getElementById("bm-e"),r=document.getElementById("bm-f");const a=m(t,e),l=`(Tl X: ${t[0]}, Tl Y: ${t[1]}, Px X: ${e[0]}, Px Y: ${e[1]})`,c=`(${a[0].toFixed(5)}, ${a[1].toFixed(5)})`;if(n)n.textContent=l,o.textContent=c;else{n=document.createElement("span"),n.id="bm-x",n.textContent=l,n.style="margin-left: calc(var(--spacing)*3); font-size: small;",i.parentNode.parentNode.parentNode.insertAdjacentElement("afterend",n);const t=function(){const t=this.dataset.text;v(t),alert("Copied to clipboard: "+t)};s=document.createElement("a"),s.href="#",s.id="bm-e",s.textContent="Copy",s.style="font-size: small; text-decoration: underline;",s.className="text-nowrap",s.addEventListener("click",t),n.insertAdjacentElement("afterend",s),n.insertAdjacentText("afterend"," ");const e=document.createElement("br");s.insertAdjacentElement("afterend",e),o=document.createElement("span"),o.id="bm-y",o.textContent=c,o.style="margin-left: calc(var(--spacing)*3); font-size: small;",e.insertAdjacentElement("afterend",o),r=document.createElement("a"),r.href="#",r.id="bm-f",r.textContent="Copy",r.style="font-size: small; text-decoration: underline;",r.className="text-nowrap",r.addEventListener("click",t),o.insertAdjacentElement("afterend",r),o.insertAdjacentText("afterend"," ")}s.dataset.text=l,r.dataset.text=c}}_e(){if(4!==this.qe.length)return;const t=[this.qe[0],this.qe[1]],e=[this.qe[2],this.qe[3]],n=document.querySelectorAll("dialog.modal > div");for(const i of n){if(null===i.querySelector("input[readonly]"))continue;let n=document.querySelector("#bm-z"),o=document.querySelector("#bm-i"),s=document.querySelector("#bm-s"),r=document.querySelector("#bm-7");if(!n){const t=document.createElement("div");i.appendChild(t);const e=document.createElement("h3");e.innerText="Download as Template",e.className="mb-1 mt-5 flex items-center gap-1 text-xl font-semibold",t.appendChild(e);const a=document.createElement("div");a.className="bg-base-200 border-base-content/10 rounded-xl border-2 p-3",a.style.fontSize="small",a.innerText=["Instruction to mark the rectangular range for downloading:",'1. Pick the first reference point (e.g. the Top Left Corner) and use the "Pin" icon to record the coordinates.','2. Pick the second reference point, i.e. the opposite corner (e.g. the Bottom Right Corner), and click the "Share" button.'].join("\n"),t.appendChild(a),o=document.createElement("span"),o.id="bm-i",o.style.fontSize="small",t.appendChild(o),t.appendChild(document.createElement("br"));const l=document.createElement("div");l.className="mt-3 flex items-end justify-end gap-2",s=document.createElement("progress"),s.id="bm-s",s.max="100",s.value="0",s.hidden=!0,l.appendChild(s),r=document.createElement("span"),r.id="bm-7",r.hidden=!0,r.textContent="0 / 0",l.appendChild(r),n=document.createElement("button"),n.id="bm-z",n.className="btn btn-primary";const c=document.createElementNS("http://www.w3.org/2000/svg","svg");c.setAttribute("xmlns","http://www.w3.org/2000/svg"),c.setAttribute("viewBox","0 -960 960 960"),c.setAttribute("fill","currentColor"),c.setAttribute("class","size-5");const m=document.createElementNS("http://www.w3.org/2000/svg","path");m.setAttribute("d","M480-320 280-520l56-58 104 104v-326h80v326l104-104 56 58-200 200ZM240-160q-33 0-56.5-23.5T160-240v-120h80v120h480v-120h80v120q0 33-23.5 56.5T720-160H240Z"),c.appendChild(m),n.appendChild(c),n.appendChild(document.createTextNode(" Download"));const d=this;n.addEventListener("click",async function(){this.disabled=!0;const t=[d.qe[0],d.qe[1]],e=[d.qe[2],d.qe[3]];if(!f())return void alert("Some coordinates textboxes are empty or invalid!");const n=p(),[[i,o],[a,l]]=w([t,e],n),c=Math.floor(i/1e3),m=Math.floor(o/1e3),u=i%1e3,h=o%1e3,b=Math.floor((i+a-1)/1e3),g=Math.floor((o+l-1)/1e3),v=b-c+1,y=g-m+1;s.max=v*y,s.value=0,s.hidden=!1,r.textContent=`0 / ${s.max}`,r.hidden=!1;try{const t=new OffscreenCanvas(a,l),e=t.getContext("2d");e.clearRect(0,0,a,l);for(let t=m;t<=g;t++)for(let n=c;n<=b;n++){const a=await x(n%2048,t);e.drawImage(a,1e3*n-i,1e3*t-o),s.value++,r.textContent=`${s.value} / ${s.max}`}const n=await t.convertToBlob({type:"image/png"});var $=document.createElement("a");$.href=URL.createObjectURL(n,{type:"image/png"}),$.setAttribute("download",`template_${c}_${m}_${u}_${h}_${(new Date).toISOString()}.png`),$.click(),URL.revokeObjectURL($.href)}catch(t){throw alert("Download Failed!"),t}finally{s.hidden=!0,r.hidden=!0,this.disabled=!1}}),l.appendChild(n),t.appendChild(l)}const a=[];if(f()){const i=p(),[[o,s],[r,l]]=w([t,e],i),c=Math.floor(o/1e3),m=Math.floor(s/1e3),d=o%1e3,u=s%1e3,h=(o+r-1)%2048e3,b=s+l-1,f=Math.floor(h/1e3),g=Math.floor(b/1e3),v=h%1e3,x=b%1e3;a.push(`Top Left: (Tl X: ${c}, Tl Y: ${m}, Px X: ${d}, Px Y: ${u})`),a.push(`Bottom Right: (Tl X: ${f}, Tl Y: ${g}, Px X: ${v}, Px Y: ${x})`),a.push(`Image Size: ${r}×${l}`),y(r,l)?n.disabled=!1:(n.disabled=!0,a.push("Too large for the browser to export."))}else a.push("Some coordinates textboxes are empty or invalid."),n.disabled=!0;o.innerText=a.join("\n")}}We(t){o(this,C,k).call(this),window.addEventListener("message",async e=>{const n=e.data,i=n.jsonData;if(!n||"blue-marble"!==n.source)return;if(!n.endpoint)return;const s=n.endpoint?.split("?")[0].split("/").filter(t=>t&&isNaN(Number(t))).filter(t=>t&&!t.includes(".")).pop();switch(s){case"me":if(i.status&&"2"!=i.status?.toString()[0])return void(i.fallback||t.Nt("You are not logged in!\nCould not fetch userdata."));o(this,C,D).call(this,i,Date.now());break;case"pixel":const e=n.endpoint.split("?")[0].split("/").filter(t=>t&&!isNaN(Number(t))).map(t=>Number(t)),s=new URLSearchParams(n.endpoint.split("?")[1]),r=[+s.get("x"),+s.get("y")];if(this.qe.length&&(!e.length||!r.length))return void t.Nt("Coordinates are malformed!\nDid you try clicking the canvas first?");this.qe=[...e,...r],this.Xe(),this._e();break;case"tiles":let a=n.endpoint.split("/");a=[parseInt(a[a.length-2]),parseInt(a[a.length-1].replace(".png",""))];const l=n.blobID,c=n.blobData,m=a[0].toString().padStart(4,"0")+","+a[1].toString().padStart(4,"0"),d=n.lastModified,u=this.Z.we(a);let h=null;this.Ge[m]&&this.Ge[m].lastModified===d&&this.Ge[m].fullKey===u&&(h=this.Ge[m].templateBlob),null===h&&(this.Z.re(a).length>0?(h=await this.Z.se(c,a),this.Ge[m]={lastModified:d,fullKey:u,templateBlob:h}):h=c),window.postMessage({source:"blue-marble",blobID:l,blobData:h,blink:n.blink});break;case"claimed":this.Je=i.claimed??[],this.Z.ee();break;case"robots":this.Ue="false"==i.userscript?.toString().toLowerCase()}})}}(B);N.ot(I),GM.getValue("bmTemplates","{}").then(async t=>{const e=await GM.getValue("bmUserSettings","{}");let n,i;try{n=JSON.parse(e)}catch{n={}}if(0==Object.keys(n).length){const t=crypto.randomUUID();B.$e({uuid:t,hideLockedColors:!1,progressBarEnabled:!0,hideCompletedColors:!1,sortBy:"total-desc",anchor:"lt",smartPlace:!1,memorySavingMode:!1,eventEnabled:!1,eventProvider:"",eventClaimedShown:!0,eventUnavailableShown:!0}),B.xe()}else B.$e(n);try{i=JSON.parse(t)}catch{i={}}B.fe(i),await async function(){let t=!1,e={};const n=await GM.getValue("bmCoords","{}");try{e=JSON.parse(n)||{}}catch{e={}}N.dt({id:"bm-11",style:"top: 10px; right: 75px;"}).dt({id:"bm-E"}).dt({id:"bm-10"}).st().vt({alt:"Blue Marble Icon - Click to minimize/maximize",src:"https://raw.githubusercontent.com/SwingTheVine/Wplace-BlueMarble/main/dist/assets/Favicon.png",style:"cursor: pointer;"},(e,n)=>{n.addEventListener("click",()=>{t=!t;const i=document.querySelector("#bm-11"),o=document.querySelector("#bm-E"),s=document.querySelector("#bm-10"),r=document.querySelector("#bm-F"),a=document.querySelector("#bm-M"),l=document.querySelector("#bm-N"),c=document.querySelector("#bm-O"),m=document.querySelector("#bm-G"),d=document.querySelector("#bm-t"),u=document.querySelectorAll("#bm-F input");t||(i.style.width="auto",i.style.maxWidth="300px",i.style.minWidth="200px",i.style.padding="10px"),["#bm-11 h1","#bm-u","#bm-11 hr","#bm-o > *:not(#bm-F)","#bm-8",`#${e.it}`].forEach(e=>{document.querySelectorAll(e).forEach(e=>{e.style.display=t?"none":""})}),t?(r&&(r.style.display="none"),a&&(a.style.display="none"),l&&(l.style.display="none"),c&&(c.style.display="none"),m&&(m.style.display="none"),B.ne()&&(d.style.display="none"),u.forEach(t=>{t.style.display="none"}),i.style.width="60px",i.style.height="76px",i.style.maxWidth="60px",i.style.minWidth="60px",i.style.padding="8px",n.style.marginLeft="3px",o.style.textAlign="center",o.style.margin="0",o.style.marginBottom="0",s&&(s.style.display="",s.style.marginBottom="0.25em")):(r&&(r.style.display="",r.style.flexDirection="",r.style.justifyContent="",r.style.alignItems="",r.style.gap="",r.style.textAlign="",r.style.margin=""),a&&(a.style.display=""),l&&(l.style.display="",l.style.marginTop=""),c&&(c.style.display="",c.style.marginTop=""),m&&(m.style.display="",m.style.marginTop=""),B.ne()?d.style.display="":d.style.display="none",u.forEach(t=>{t.style.display=""}),n.style.marginLeft="",i.style.padding="10px",o.style.textAlign="",o.style.margin="",o.style.marginBottom="",s&&(s.style.marginBottom="0.5em"),i.style.width="",i.style.height=""),n.alt=t?"Blue Marble Icon - Minimized (Click to maximize)":"Blue Marble Icon - Maximized (Click to minimize)"})}).st().wt(1,{textContent:L}).gt({textContent:` v${E}`}).st().st().st().yt().st().dt({id:"bm-u"}).ut({textContent:"Username: "}).bt({id:"bm-W"}).st().st().ut({id:"bm-Q"},(t,e)=>{e.setAttribute("aria-live","polite")}).ft("Full Charges in ").ht({className:"bm-v",textContent:"--:--"},(t,e)=>{e.dataset.role="countdown"}).st().ft(" ").ht({className:"bm-R",textContent:"(0 / 0)"},(t,e)=>{e.dataset.role="charge-count"}).st().st().ut({textContent:"Droplets: "}).bt({id:"bm-K"}).st().st().ut().bt({id:"bm-C",textContent:"--"}).st().ft(" more pixel").ht({id:"bm-c",textContent:"s"}).st().ft(" to Lv. ").bt({id:"bm-D",textContent:"--"}).st().st().st().yt().st().dt({id:"bm-o"}).dt({id:"bm-F"}).Ct({id:"bm-M",className:"bm-17",style:"margin-top: 0;",innerHTML:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 4 6"><circle cx="2" cy="2" r="2"></circle><path d="M2 6 L3.7 3 L0.3 3 Z"></path><circle cx="2" cy="2" r="0.7" fill="white"></circle></svg></svg>'},(t,e)=>{e.onclick=()=>{const e=t.nt?.qe;e?.[0]?(t.St("bm-Y",e?.[0]||""),t.St("bm-Z",e?.[1]||""),t.St("bm--",e?.[2]||""),t.St("bm-_",e?.[3]||""),I._e(),P()):t.Nt("Coordinates are malformed! Did you try clicking on the canvas first?")}}).st().Dt({type:"number",id:"bm-Y",placeholder:"Tl X",min:0,max:2047,step:1,required:!0,value:e.tx??""},(t,e)=>{e.addEventListener("paste",t=>{const e=(t.clipboardData||window.clipboardData).getData("text"),n=[/^\s*([012]?\d{1,3}),\s*([012]?\d{1,3}),\s*(\d{1,3}),\s*(\d{1,3})\s*$/,/^\s*([012]?\d{1,3})\s+([012]?\d{1,3})\s+(\d{1,3})\s+(\d{1,3})\s*$/,/^\s*\(?Tl X: ([012]?\d{1,3}), Tl Y: ([012]?\d{1,3}), Px X: (\d{1,3}), Px Y: (\d{1,3})\)?\s*$/].map(t=>t.exec(e)).filter(t=>t).pop();if(void 0===n)return;let i=n.slice(1).map(Number),o=(s=document,coords=[],coords.push(s.querySelector("#bm-Y")),coords.push(s.querySelector("#bm-Z")),coords.push(s.querySelector("#bm--")),coords.push(s.querySelector("#bm-_")),coords);var s;for(let t=0;t<o.length;t++)o[t].value=i[t];I._e(),t.preventDefault()});const n=()=>(I._e(),P());e.addEventListener("input",n),e.addEventListener("change",n)}).st().Dt({type:"number",id:"bm-Z",placeholder:"Tl Y",min:0,max:2047,step:1,required:!0,value:e.ty??""},(t,e)=>{const n=()=>(I._e(),P());e.addEventListener("input",n),e.addEventListener("change",n)}).st().Dt({type:"number",id:"bm--",placeholder:"Px X",min:0,max:2047,step:1,required:!0,value:e.px??""},(t,e)=>{const n=()=>(I._e(),P());e.addEventListener("input",n),e.addEventListener("change",n)}).st().Dt({type:"number",id:"bm-_",placeholder:"Px Y",min:0,max:2047,step:1,required:!0,value:e.py??""},(t,e)=>{const n=()=>(I._e(),P());e.addEventListener("input",n),e.addEventListener("change",n)}).st().Ct({id:"bm-A",className:"bm-17",style:"margin-top: 0;",innerHTML:"✈️",title:"Teleport"},(t,e)=>{e.onclick=()=>{j()}}).st().st().Mt({id:"bm-p",textContent:"User Settings",style:"max-width: 100%; white-space: nowrap; border: 1px solid rgba(255,255,255,0.1); padding: 4px; border-radius: 4px; margin-top: 4px;"}).dt({style:"display: flex; flex-direction: column; gap: 4px;"}).$t({id:"bm-2",textContent:"Hide Locked Colors",checked:B.ge()},(t,e,n)=>{e.style.fontSize="12px",n.addEventListener("change",()=>{B.Me(n.checked),buildColorFilterList(),n.checked?t.Bt("Hidden all locked colors."):t.Bt("Restored all colors.")})}).st().$t({id:"bm-0",textContent:"Hide Completed Colors",checked:B.Oe()},(t,e,n)=>{e.style.fontSize="12px",n.addEventListener("change",()=>{B.Le(n.checked),buildColorFilterList(),n.checked?t.Bt("Hidden all completed colors."):t.Bt("Restored all colors.")})}).st().$t({id:"bm-g",textContent:"Show Progress Bar",checked:B.Te()},(t,e,n)=>{e.style.fontSize="12px",n.addEventListener("change",()=>{B.De(n.checked),buildColorFilterList(),n.checked?t.Bt("Progress Bar Enabled."):t.Bt("Progress Bar Disabled.")})}).st().$t({id:"bm-d",textContent:"Memory-Saving Mode",checked:B.U()},(t,e,n)=>{e.style.fontSize="12px",n.addEventListener("change",()=>{B.Ee(n.checked),buildColorFilterList(),n.checked?t.Bt("Memory Saving Mode Enabled. The Effect will be Fully Active After a Page Refresh."):t.Bt("Memory Saving Mode Disabled. The Effect will be Fully Active After a Page Refresh.")})}).st().$t({id:"bm-P",textContent:"Enable Event",checked:B.ne()},(t,e,n)=>{e.style.fontSize="12px",n.addEventListener("change",()=>{B.Ie(n.checked),n.checked?(t.Bt("Event Mode Enabled."),document.getElementById("bm-t").style.display="",buildEventList()):(t.Bt("Event Mode Disabled."),document.getElementById("bm-t").style.display="none")})}).st().$t({id:"bm-q",textContent:"Hide Event Claimed Items",checked:!B.Pe()},(t,e,n)=>{e.style.fontSize="12px",n.addEventListener("change",()=>{B.je(!n.checked),n.checked?t.Bt("Hidden All Event Claimed Items."):t.Bt("Restored All Event Claimed Items."),buildEventList()})}).st().$t({id:"bm-9",textContent:"Hide Unavailable Event Items",checked:!B.Re()},(t,e,n)=>{e.style.fontSize="12px",n.addEventListener("change",()=>{B.Fe(!n.checked),n.checked?t.Bt("Hidden All Unavailable Event Items."):t.Bt("Restored All Unavailable Event Items."),buildEventList()})}).st().st().st().Mt({id:"bm-j",textContent:"Colors",style:"border: 1px solid rgba(255,255,255,0.1); padding: 4px; border-radius: 4px; margin-top: 4px;"},(t,e,n)=>{n.open=!0}).ut({textContent:"Sort Colors by ",style:"font-size: small; margin-top: 3px; margin-left: 5px;"}).Tt({id:"bm-U"},(t,e)=>{const n=["Asc","Desc"],i=B.Ce();Object.keys(g).forEach(t=>{n.forEach(n=>{const o=document.createElement("option");o.value=`${t.toLowerCase()}-${n.toLowerCase()}`,o.textContent=`${t[0].toUpperCase()+t.slice(1).toLowerCase()} (${n}.)`,o.value===i&&(o.selected=!0),e.appendChild(o)})}),e.addEventListener("change",()=>{B.Se(e.value),buildColorFilterList();const n=e.value.split("-");t.Bt(`Changed the sort criteria to "${n[0][0].toUpperCase()+n[0].slice(1).toLowerCase()}" in ${n[1]}ending order.`)})}).st().st().dt({id:"bm-6",style:"display: flex; gap: 6px; margin-top: 3px; margin-bottom: 0px;"}).Ct({id:"bm-3",textContent:"Enable All"},(t,e)=>{e.onclick=()=>{B.Y.forEach(t=>{t?.O&&Object.values(t.O).forEach(t=>t.enabled=!0)}),syncToggleList(),buildColorFilterList(),t.Bt("Enabled all colors")}}).st().Ct({id:"bm-1",textContent:"Disable All"},(t,e)=>{e.onclick=()=>{B.Y.forEach(t=>{t?.O&&Object.values(t.O).forEach(t=>t.enabled=!1)}),syncToggleList(),buildColorFilterList(),t.Bt("Disabled all colors")}}).st().st().dt({id:"bm-w",style:"max-height: 125px; overflow: auto; display: flex; flex-direction: column; gap: 4px;"}).st().st().Mt({id:"bm-a",textContent:"Templates",style:"border: 1px solid rgba(255,255,255,0.1); padding: 4px; border-radius: 4px; margin-top: 4px;"},(t,e,n)=>{n.open=!0}).dt({id:"bm-4"}).Ot({id:"bm-k",textContent:"Select Image",accept:"image/png, image/jpeg, image/webp, image/bmp, image/gif"}).Ct({id:"bm-N",textContent:"Create Template",style:"margin: 0 1ch;"},(t,e)=>{e.onclick=async()=>{const e=document.querySelector("#bm-k"),n=document.querySelector("#bm-Y");if(!n.checkValidity())return n.reportValidity(),void t.Nt("Coordinates are malformed! Did you try clicking on the canvas first?");const i=document.querySelector("#bm-Z");if(!i.checkValidity())return i.reportValidity(),void t.Nt("Coordinates are malformed! Did you try clicking on the canvas first?");const o=document.querySelector("#bm--");if(!o.checkValidity())return o.reportValidity(),void t.Nt("Coordinates are malformed! Did you try clicking on the canvas first?");const s=document.querySelector("#bm-_");if(!s.checkValidity())return s.reportValidity(),void t.Nt("Coordinates are malformed! Did you try clicking on the canvas first?");e?.files[0]?(await B.Wt(e.files[0],e.files[0]?.name.replace(/\.[^/.]+$/,""),[Number(n.value),Number(i.value),Number(o.value),Number(s.value)]),t.Bt("Drew to canvas!")):t.Nt("No file selected!")}}).st().Tt({id:"bm-B"},(t,e)=>{const n={l:"Left",m:"Center",r:"Right"},i={t:"Top",m:"Middle",b:"Bottom"},o=B.Vt();Object.entries({lt:"⟔",mt:"⨪",rt:"ᒬ",lm:"꜏",mm:"⊡",rm:"꜊",lb:"Ŀ",mb:"∸",rb:"⟓"}).forEach(([t,n])=>{const i=document.createElement("option");i.value=t,i.textContent=n,t===o&&(i.selected=!0),e.appendChild(i)}),e.addEventListener("change",()=>{B.Be(e.value),t.Bt(`Changed the default template anchor to "${i[e.value[1]]} ${n[e.value[0]]}".`)})}).st().st().dt({id:"bm-l",style:"max-height: 125px; overflow: auto; display: flex; flex-direction: column; gap: 4px;"}).st().st().Mt({id:"bm-t",textContent:"Event",style:"border: 1px solid rgba(255,255,255,0.1); padding: 4px; border-radius: 4px; display: none; margin-top: 4px;"},(t,e,n)=>{B.ne()&&(n.style.display=""),n.open=!0}).Ct({id:"bm-5",textContent:"Set Data Provider",style:"margin: 0 1ch;"},(t,e)=>{e.onclick=()=>{const t=B.Ae(),e=prompt("Enter the event data provider JSON URL:",""===t?"https://wplace.samuelscheit.com/tiles/pumpkin.json":t);e&&((t=>{try{return Boolean(new URL(t))}catch(t){return!1}})(e)?(B.He(e),buildEventList()):alert("The URL you entered is not valid!"))}}).st().Ct({id:"bm-h",textContent:"Refresh Data",style:"margin: 0 1ch;"},(t,e)=>{e.onclick=()=>buildEventList()}).st().dt({id:"bm-H",style:"max-height: 125px; overflow: auto; display: flex; flex-direction: column; gap: 4px;"}).st().st().Lt({id:N.it,placeholder:`Status: Sleeping...\nVersion: ${E}`,readOnly:!0}).st().dt({id:"bm-8"}).dt().Ct({id:"bm-I",className:"bm-17",innerHTML:"🎨",title:"Template Color Converter"},(t,e)=>{e.addEventListener("click",()=>{window.open("https://pepoafonso.github.io/color_converter_wplace/","_blank","noopener noreferrer")})}).st().Ct({id:"bm-J",className:"bm-17",innerHTML:"🌐",title:"Official Blue Marble Website"},(t,e)=>{e.addEventListener("click",()=>{window.open("https://bluemarble.camilledaguin.fr/","_blank","noopener noreferrer")})}).st().st().dt({id:"bm-15"}).gt({textContent:"by SwingTheVine | Forked by TWY",style:"margin-top: auto;"}).st().st().st().st().ct(document.body),window.syncToggleList=function(){try{(B.Y??[]).forEach(t=>{const e=t.N;if(e&&B.Ut?.templates?.[e]){const n=B.Ut.templates[e];n.enabled=t.enabled,n.palette=t.O}}),B.te()}catch(t){}},window.buildColorFilterList=function(){const t=document.querySelector("#bm-w"),e=B.Kt(),n=B.Oe(),i=B.ge();t.innerHTML="";let o=!1;const s={};if((B.Y??[]).forEach(t=>{if(t.enabled&&t?.O){o=!0;for(const[e,n]of Object.entries(t.O))s[e]=(s[e]??0)+n.count}}),!t||!o)return void(t&&(t.innerHTML="<small>No template colors to display.</small>"));const r={};for(const t of B.qt.values())Object.entries(t.palette).forEach(([t,e])=>{void 0===r[t]?(r[t]=Object.fromEntries(Object.entries(e)),r[t].he=e.he.slice(),r[t].be=e.be.slice()):(r[t].painted+=e.painted,r[t].de+=e.de,r[t].ue+=e.ue,r[t].he.push(...e.he),r[t].be.push(...e.be))});const a=B.Ce().split("-"),l=g[a[0]],m="asc"===a[1]?(t,e)=>l(t)-l(e):(t,e)=>l(e)-l(t),d=Object.entries(s).map(([t,e])=>[t,r[t]?.de??0,e]).sort(m);let u=!1;for(const[o,s,l]of d){if(i&&"other"===o)continue;if(n&&s===l)continue;let m=document.createElement("div");m.style.display="flex",m.style.alignItems="center",m.style.gap="6px";let d=document.createElement("div");d.style.width="14px",d.style.height="14px",d.style.border="1px solid rgba(255,255,255,0.5)";let b="",p="";if("other"===o)d.style.background="#888",b="Other",p="other";else if("#deface"===o)d.style.background="#deface",b="Transparent",p="transparent";else{const[t,e,n]=o.split(",").map(Number);d.style.background=`rgb(${t},${e},${n})`;try{const s=c.get(o);if(s&&"number"==typeof s.id){if(i&&!B.ve(s.id))continue;const o=s?.name||`rgb(${t},${e},${n})`;s.premium&&(d.style.borderColor="gold",d.style.boxShadow="0 0 2px yellow"),b=`#${s.id} ${o}`,p=`${t},${e},${n}`}}catch(t){}}let f=document.createElement("span");if(f.style.fontSize="12px","remaining"===a[0]||n&&"painted"!==a[0]){const t=(l-s).toLocaleString();f.textContent=`${b} • ${t} Left`}else{const t=l.toLocaleString(),e=s.toLocaleString();f.textContent=`${b} • ${e} / ${t}`}if(B.Te()){const t=s/(0===l?1:l)*100;m.style.background=`linear-gradient(to right, rgb(0, 128, 0, 0.8) 0%, rgb(0, 128, 0, 0.8) ${t}%, transparent ${t}%, transparent 100%)`}const g=r[p];let v=0;d.addEventListener("click",()=>{if((g?.be?.length??0)>0){const t=g.be,e=v%t.length;h(t[e][0],t[e][1]),++v}}),(g?.be?.length??0)>0&&(d.style.cursor="pointer");const w=document.createElement("input");w.type="checkbox",w.checked=e[o]??!0,w.addEventListener("change",()=>{(B.Y??[]).forEach(t=>{t?.O&&void 0!==t.O[o]&&(t.O[o].enabled=w.checked)}),N.Bt(`${w.checked?"Enabled":"Disabled"} ${o}`),syncToggleList()}),m.appendChild(w),m.appendChild(d),m.appendChild(f),t.appendChild(m),u=!0}!u&&t&&(t.innerHTML=i?n?"<small>All owned colors have been completed.</small>":"<small>Remaining colors are all locked.</small>":"<small>All colors have been completed.</small>")},window.buildTemplateFilterList=function(){const t=document.querySelector("#bm-l");if(s(B),0===B.Y?.length)return void(t&&(t.innerHTML="<small>No templates to display.</small>"));t.innerHTML="";const e=B.Y,n={};for(const t of B.qt.values())Object.entries(t.Ht).forEach(([t,e])=>{void 0===n[t]?n[t]=Object.fromEntries(Object.entries(e)):n[t].painted+=e.painted});for(const i of e){let e=document.createElement("div");e.style.display="flex",e.style.alignItems="center",e.style.gap="6px";let o=document.createElement("a");o.title="Remove template",o.textContent="🗑️",o.style.fontSize="12px",o.onclick=()=>{confirm(`Remove template ${i?.displayName}?`)&&B.ie(i?.N)};let s=document.createElement("a");s.title="Teleport to template",s.textContent="✈️",s.style.fontSize="12px",s.onclick=()=>{h(i.coords.slice(0,2),i.coords.slice(2,4))};let r=document.createElement("span");r.style.fontSize="12px";const a=`${i.T.toLocaleString()}`,l=i.displayName,c=`${(n[i.N]?.painted??0).toLocaleString()}`;r.textContent=`${l} • ${c} / ${a}`;const m=document.createElement("input");m.type="checkbox",m.checked=i.enabled,m.addEventListener("change",()=>{i.enabled=m.checked,N.Bt(`${m.checked?"Enabled":"Disabled"} ${l}`),m.checked||B.Zt(i),syncToggleList()}),e.appendChild(m),e.appendChild(o),e.appendChild(r),e.appendChild(s),t.appendChild(e)}},window.buildEventList=function(){const t=document.querySelector("#bm-H"),e=B.Pe(),n=B.Re(),i=B.Ae();if(null===i||""==i)return void(t.innerHTML="<small>Event data provider is not set.</small>");if(null===I.Je)return void(t.innerHTML="<small>The event claimed items list is not loaded. Make sure you have clicked the ongoing Event button from the top left corner.</small>");const o=new Set(I.Je);s("eventClaimedList",o),fetch(i).then(t=>t.json()).then(i=>{if(s("event Location data",i),"object"!=typeof i)return void(t.innerHTML="<small>The event data provider does not provide a known format.</small>");t.textContent="";let r=!1;Object.entries(i).forEach(([i,s])=>{if(i=Number(i),o.has(i)&&!e)return;const a=document.createElement("div");a.style.display="flex",a.style.alignItems="center",a.style.gap="6px";let l=null,c="";if("object"==typeof s&&(void 0!==s.lat&&void 0!==s.lng?l=[s.lat,s.lng]:void 0!==s.tileX&&void 0!==s.offsetX&&void 0!==s.tileY&&void 0!==s.offsetY&&(l=m([s.tileX,s.tileY],[s.offsetX,s.offsetY])),void 0!==s.foundAt)){const t=Date.now(),e=t-t%36e5,i=new Date(s.foundAt).getTime();if(e!==i-i%36e5&&(c="Expired • ",!n))return}if(null!==l){let t=document.createElement("a");t.title="Teleport to template",t.textContent="✈️",t.style.fontSize="12px",t.onclick=()=>{u(l[0],l[1],!1)},a.appendChild(t)}else c="Unknown Coordinate Format • ";let d=document.createElement("span");d.style.fontSize="12px",d.textContent=`#${i} • ${c}${o.has(i)?"Claimed":"Unclaimed"}`,a.appendChild(d),t.appendChild(a),r=!0}),!r&&t&&(t.innerHTML=`<small>No ${e?"":"unclaimed "}items have ${n?"":"recent "}data available.</small>`)}).catch(e=>{t.innerHTML="<small>Failed fetching the event item info from the event data provider. Make sure the provider URL is a valid JSON resource and can be accessed with appropriate CORS.</small>"})},window.addEventListener("message",t=>{if("bm-m"===t?.data?.X)try{buildColorFilterList()}catch(t){}else if("bm-b"===t?.data?.X)try{buildTemplateFilterList()}catch(t){}else if("bm-n"===t?.data?.X)try{buildEventList()}catch(t){}}),setTimeout(()=>{try{B.Y?.length>0&&buildColorFilterList(),B.Y?.length>0&&buildTemplateFilterList()}catch(t){}try{B.ne()&&buildEventList()}catch(t){}},0)}(),N.Et("#bm-11","#bm-10"),I.We(N),new MutationObserver((t,e)=>{const n=document.querySelector("#color-1");if(!n)return;let i=document.querySelector("#bm-T");if(!i){i=document.createElement("button"),i.id="bm-T",i.textContent="Move ↑",i.className="btn btn-soft",i.onclick=function(){const t=this.parentNode.parentNode.parentNode.parentNode,e="Move ↑"==this.textContent;t.parentNode.className=t.parentNode.className.replace(e?"bottom":"top",e?"top":"bottom"),t.style.borderTopLeftRadius=e?"0px":"var(--radius-box)",t.style.borderTopRightRadius=e?"0px":"var(--radius-box)",t.style.borderBottomLeftRadius=e?"var(--radius-box)":"0px",t.style.borderBottomRightRadius=e?"var(--radius-box)":"0px",this.textContent=e?"Move ↓":"Move ↑"};const t=n.parentNode.parentNode.parentNode.parentNode.querySelector("h2");t.parentNode?.appendChild(i)}if(B.zt?.smartPlace){let t=document.querySelector("#bm-S");if(!t){t=document.createElement("button"),t.id="bm-S",t.textContent="Paint",t.className="btn btn-soft",t.onclick=function(){const t=Math.floor(I.W());let e=[];const n=B.Kt();for(const t of B.qt.values())Object.entries(t.palette).forEach(([t,i])=>{if(!c.has(t))return;if(!n?.[t])return;const o=c.get(t).id;B.ve(o)&&e.push(...i.be.map(t=>[o,t]))});let i;if(0===e.length)return;try{const t=function(t,...e){const n=document.querySelector(".right-3>button");if(null!==n){if(void 0!==n.__click)return t(n.__click[3].v,...e);{const n=()=>document.querySelector(".right-3>button").__click[3].v,i=t=>{document.currentScript.setAttribute("bm-12",JSON.stringify(t))},o=e.map(t=>JSON.stringify(t)).join(","),s=document.createElement("script");s.textContent=`(${i})((${t})((${n})(), ${o}));`,document.documentElement?.appendChild(s);const r=JSON.parse(s.getAttribute("bm-12"));return s.remove(),r}}throw new Error('Could not find the "My location" button.')}(t=>{const e=t.transform.center;return[e.lat,e.lng]}),e=function(t,e){const n=(e+180)/360,i=(Math.log(Math.tan((90+t)*Math.PI/360))/Math.PI+1)/2,o=Math.floor(2048*n*1e3),s=Math.floor(2048*(1-i)*1e3);return[[Math.floor(o/1e3),Math.floor(s/1e3)],[o%1e3,s%1e3]]}(t[0],t[1]);i=[e[0][0]*B.k+e[1][0],e[0][1]*B.k+e[1][1]]}catch{const t=e[Math.floor(Math.random()*e.length)][1];i=[t[0][0]*B.k+t[1][0],t[0][1]*B.k+t[1][1]]}if(e.length<=t);else if(e.length<5e3)e=e.sort(([t,e],[n,o])=>{const s=[e[0][0]*B.k+e[1][0],e[0][1]*B.k+e[1][1]],r=[o[0][0]*B.k+o[1][0],o[0][1]*B.k+o[1][1]];return Math.sqrt(Math.pow(s[0]-i[0],2)+Math.pow(s[1]-i[1],2))*(1+.2*Math.random())-Math.sqrt(Math.pow(r[0]-i[0],2)+Math.pow(r[1]-i[1],2))*(1+.2*Math.random())}).slice(0,t);else{const n={},o=[];e.forEach(([t,e])=>{const o=[e[0][0]*B.k+e[1][0],e[0][1]*B.k+e[1][1]],s=Math.floor(Math.sqrt(Math.pow(o[0]-i[0],2)+Math.pow(o[1]-i[1],2))*(1+.2*Math.random()));void 0===n[s]?n[s]=[[t,e]]:n[s].push([t,e])});const s=Object.keys(n).sort((t,e)=>t-e);for(const e of s)if(o.push(...n[e]),o.length>=t)break;e=o.slice(0,t)}const o=document.querySelector("canvas.maplibregl-canvas");for(let t=0;t<e.length;t++){const[n,i]=e[t];document.getElementById("color-"+n).click(),h(i[0],i[1],!1);const s=new MouseEvent("click",{bubbles:!0,cancelable:!0,clientX:o.offsetWidth/2,clientY:o.offsetHeight/2,button:0});o.dispatchEvent(s)}h(e[0][1][0],e[0][1][1],!1)};const e=n.parentNode.parentNode.parentNode.parentNode.querySelector("h2");e.parentNode?.appendChild(t)}}}).observe(document.body,{childList:!0,subtree:!0}),s(`%c${L}%c (${E}) userscript has loaded!`,"color: cornflowerblue;","")});var P=()=>{try{const[[t,e],[n,i]]=p(),o={tx:t,ty:e,px:n,py:i};GM.setValue("bmCoords",JSON.stringify(o))}catch(t){}},j=()=>{try{const[[t,e],[n,i]]=p();h([t,e],[n,i])}catch(t){}}})();