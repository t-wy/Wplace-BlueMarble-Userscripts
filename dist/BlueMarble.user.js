// ==UserScript==
// @name         Blue Marble
// @namespace    https://github.com/SwingTheVine/
// @version      0.85.8
// @description  A userscript to automate and/or enhance the user experience on Wplace.live. Make sure to comply with the site's Terms of Service, and rules! This script is not affiliated with Wplace.live in any way, use at your own risk. This script is not affiliated with TamperMonkey. The author of this userscript is not responsible for any damages, issues, loss of data, or punishment that may occur as a result of using this script. This script is provided "as is" under the MPL-2.0 license. The "Blue Marble" icon is licensed under CC0 1.0 Universal (CC0 1.0) Public Domain Dedication. The image is owned by NASA.
// @author       SwingTheVine / TWY
// @license      MPL-2.0
// @supportURL   https://discord.gg/tpeBPy46hf
// @homepageURL  https://bluemarble.camilledaguin.fr/
// @icon         https://raw.githubusercontent.com/t-wy/Wplace-BlueMarble-Userscripts/051271c433a42db968a865b00f81bb979ee7d13f/dist/assets/Favicon.png
// @updateURL    https://raw.githubusercontent.com/t-wy/Wplace-BlueMarble-Userscripts/custom-improve/dist/BlueMarble.user.js
// @downloadURL  https://raw.githubusercontent.com/t-wy/Wplace-BlueMarble-Userscripts/custom-improve/dist/BlueMarble.user.js
// @match        https://wplace.live/*
// @grant        GM.addStyle
// @grant        GM.setValue
// @grant        GM.getValue
// @grant        GM_xmlhttpRequest
// ==/UserScript==

// Wplace  --> https://wplace.live
// License --> https://www.mozilla.org/en-US/MPL/2.0/

(()=>{var t,e,n=t=>{throw TypeError(t)},i=(t,e,i)=>e.has(t)?n("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(t):e.set(t,i),s=(t,e,i)=>(((t,e)=>{e.has(t)||n("Cannot access private method")})(t,e),i);window.OffscreenCanvas||(window.OffscreenCanvas=function(t,e){const n=document.createElement("canvas");return n.width=t,n.height=e,n.convertToBlob=function({type:t,t:e}={}){return new Promise((i,s)=>{n.toBlob(t=>{t?i(t):s(new Error("toBlob() returned null"))},t,e)})},n});var o=class{constructor(e,n){i(this,t),this.name=e,this.version=n,this.i=null,this.o="bm-i",this.l=null,this.m=null,this.u=[]}h(t){this.i=t}p(){return this.u.length>0&&(this.m=this.u.pop()),this}v(t){t?.appendChild(this.l),this.l=null,this.m=null,this.u=[]}$(n={},i=()=>{}){return i(this,s(this,t,e).call(this,"div",{},n)),this}M(n={},i=()=>{}){return i(this,s(this,t,e).call(this,"p",{},n)),this}D(n={},i=()=>{}){return i(this,s(this,t,e).call(this,"small",{},n)),this}k(n={},i=()=>{}){return i(this,s(this,t,e).call(this,"img",{},n)),this}C(n,i={},o=()=>{}){return o(this,s(this,t,e).call(this,"h"+n,{},i)),this}O(n={},i=()=>{}){return i(this,s(this,t,e).call(this,"hr",{},n)),this}N(n={},i=()=>{}){return i(this,s(this,t,e).call(this,"br",{},n)),this}T(n={},i=()=>{}){const o=s(this,t,e).call(this,"label",{textContent:n.textContent??""});delete n.textContent;const r=s(this,t,e).call(this,"input",{type:"checkbox"},n);return o.insertBefore(r,o.firstChild),this.p(),i(this,o,r),this}I(n={},i=()=>{}){return i(this,s(this,t,e).call(this,"button",{},n)),this}S(n={},i=()=>{}){const o=n.title??n.textContent??"Help: No info";delete n.textContent,n.title=`Help: ${o}`;const r={textContent:"?",className:"bm-y",onclick:()=>{this.L(this.o,o)}};return i(this,s(this,t,e).call(this,"button",r,n)),this}B(n={},i=()=>{}){return i(this,s(this,t,e).call(this,"input",{},n)),this}j(n={},i=()=>{}){const o=n.textContent??"";delete n.textContent;const r=s(this,t,e).call(this,"div"),a=s(this,t,e).call(this,"input",{type:"file",style:"display: none !important; visibility: hidden !important; position: absolute !important; left: -9999px !important; width: 0 !important; height: 0 !important; opacity: 0 !important;"},n);this.p();const c=s(this,t,e).call(this,"button",{textContent:o});return this.p(),this.p(),a.setAttribute("tabindex","-1"),a.setAttribute("aria-hidden","true"),c.addEventListener("click",()=>{a.click()}),a.addEventListener("change",()=>{c.style.maxWidth=`${c.offsetWidth}px`,a.files.length>0?c.textContent=a.files[0].name:c.textContent=o}),i(this,r,a,c),this}G(n={},i=()=>{}){return i(this,s(this,t,e).call(this,"textarea",{},n)),this}L(t,e,n=!1){const i=document.getElementById(t.replace(/^#/,""));i&&(i instanceof HTMLInputElement?i.value=e:n?i.textContent=e:i.innerHTML=e)}P(t,e){let n,i=!1,s=0,o=null,r=0,a=0,c=0,l=0;if(t=document.querySelector("#"==t?.[0]?t:"#"+t),e=document.querySelector("#"==e?.[0]?e:"#"+e),!t||!e)return void this.q(`Can not drag! ${t?"":"moveMe"} ${t||e?"":"and "}${e?"":"iMoveThings "}was not found!`);const m=()=>{if(i){const e=Math.abs(r-c),n=Math.abs(a-l);(e>.5||n>.5)&&(r=c,a=l,t.style.transform=`translate(${r}px, ${a}px)`,t.style.left="0px",t.style.top="0px",t.style.right=""),o=requestAnimationFrame(m)}};let u=null;const h=(h,d)=>{i=!0,u=t.getBoundingClientRect(),n=h-u.left,s=d-u.top;const b=window.getComputedStyle(t).transform;if(b&&"none"!==b){const t=new DOMMatrix(b);r=t.m41,a=t.m42}else r=u.left,a=u.top;c=r,l=a,document.body.style.userSelect="none",e.classList.add("dragging"),o&&cancelAnimationFrame(o),m()},d=()=>{i=!1,o&&(cancelAnimationFrame(o),o=null),document.body.style.userSelect="",e.classList.remove("dragging")};e.addEventListener("mousedown",function(t){t.preventDefault(),h(t.clientX,t.clientY)}),e.addEventListener("touchstart",function(t){const e=t?.touches?.[0];e&&(h(e.clientX,e.clientY),t.preventDefault())},{passive:!1}),document.addEventListener("mousemove",function(t){i&&u&&(c=t.clientX-n,l=t.clientY-s)},{passive:!0}),document.addEventListener("touchmove",function(t){if(i&&u){const e=t?.touches?.[0];if(!e)return;c=e.clientX-n,l=e.clientY-s,t.preventDefault()}},{passive:!1}),document.addEventListener("mouseup",d),document.addEventListener("touchend",d),document.addEventListener("touchcancel",d)}F(t){(0,console.info)(`${this.name}: ${t}`),this.L(this.o,"Status: "+t,!0)}q(t){(0,console.error)(`${this.name}: ${t}`),this.L(this.o,"Error: "+t,!0)}};function r(t,e){if(0===t)return e[0];let n="";const i=e.length;for(;t>0;)n=e[t%i]+n,t=Math.floor(t/i);return n}function a(t){let e="";for(let n=0;n<t.length;n++)e+=String.fromCharCode(t[n]);return btoa(e)}function c(t){const e=atob(t),n=new Uint8Array(e.length);for(let t=0;t<e.length;t++)n[t]=e.charCodeAt(t);return n}t=new WeakSet,e=function(t,e={},n={}){const i=document.createElement(t);this.l?(this.m?.appendChild(i),this.u.push(this.m),this.m=i):(this.l=i,this.m=i);for(const[t,n]of Object.entries(e))i[t]=n;for(const[t,e]of Object.entries(n))i[t]=e;return i};var l=[{id:0,premium:!1,name:"Transparent",rgb:[0,0,0]},{id:1,premium:!1,name:"Black",rgb:[0,0,0]},{id:2,premium:!1,name:"Dark Gray",rgb:[60,60,60]},{id:3,premium:!1,name:"Gray",rgb:[120,120,120]},{id:4,premium:!1,name:"Light Gray",rgb:[210,210,210]},{id:5,premium:!1,name:"White",rgb:[255,255,255]},{id:6,premium:!1,name:"Deep Red",rgb:[96,0,24]},{id:7,premium:!1,name:"Red",rgb:[237,28,36]},{id:8,premium:!1,name:"Orange",rgb:[255,127,39]},{id:9,premium:!1,name:"Gold",rgb:[246,170,9]},{id:10,premium:!1,name:"Yellow",rgb:[249,221,59]},{id:11,premium:!1,name:"Light Yellow",rgb:[255,250,188]},{id:12,premium:!1,name:"Dark Green",rgb:[14,185,104]},{id:13,premium:!1,name:"Green",rgb:[19,230,123]},{id:14,premium:!1,name:"Light Green",rgb:[135,255,94]},{id:15,premium:!1,name:"Dark Teal",rgb:[12,129,110]},{id:16,premium:!1,name:"Teal",rgb:[16,174,166]},{id:17,premium:!1,name:"Light Teal",rgb:[19,225,190]},{id:18,premium:!1,name:"Dark Blue",rgb:[40,80,158]},{id:19,premium:!1,name:"Blue",rgb:[64,147,228]},{id:20,premium:!1,name:"Cyan",rgb:[96,247,242]},{id:21,premium:!1,name:"Indigo",rgb:[107,80,246]},{id:22,premium:!1,name:"Light Indigo",rgb:[153,177,251]},{id:23,premium:!1,name:"Dark Purple",rgb:[120,12,153]},{id:24,premium:!1,name:"Purple",rgb:[170,56,185]},{id:25,premium:!1,name:"Light Purple",rgb:[224,159,249]},{id:26,premium:!1,name:"Dark Pink",rgb:[203,0,122]},{id:27,premium:!1,name:"Pink",rgb:[236,31,128]},{id:28,premium:!1,name:"Light Pink",rgb:[243,141,169]},{id:29,premium:!1,name:"Dark Brown",rgb:[104,70,52]},{id:30,premium:!1,name:"Brown",rgb:[149,104,42]},{id:31,premium:!1,name:"Beige",rgb:[248,178,119]},{id:32,premium:!0,name:"Medium Gray",rgb:[170,170,170]},{id:33,premium:!0,name:"Dark Red",rgb:[165,14,30]},{id:34,premium:!0,name:"Light Red",rgb:[250,128,114]},{id:35,premium:!0,name:"Dark Orange",rgb:[228,92,26]},{id:36,premium:!0,name:"Light Tan",rgb:[214,181,148]},{id:37,premium:!0,name:"Dark Goldenrod",rgb:[156,132,49]},{id:38,premium:!0,name:"Goldenrod",rgb:[197,173,49]},{id:39,premium:!0,name:"Light Goldenrod",rgb:[232,212,95]},{id:40,premium:!0,name:"Dark Olive",rgb:[74,107,58]},{id:41,premium:!0,name:"Olive",rgb:[90,148,74]},{id:42,premium:!0,name:"Light Olive",rgb:[132,197,115]},{id:43,premium:!0,name:"Dark Cyan",rgb:[15,121,159]},{id:44,premium:!0,name:"Light Cyan",rgb:[187,250,242]},{id:45,premium:!0,name:"Light Blue",rgb:[125,199,255]},{id:46,premium:!0,name:"Dark Indigo",rgb:[77,49,184]},{id:47,premium:!0,name:"Dark Slate Blue",rgb:[74,66,132]},{id:48,premium:!0,name:"Slate Blue",rgb:[122,113,196]},{id:49,premium:!0,name:"Light Slate Blue",rgb:[181,174,241]},{id:50,premium:!0,name:"Light Brown",rgb:[219,164,99]},{id:51,premium:!0,name:"Dark Beige",rgb:[209,128,81]},{id:52,premium:!0,name:"Light Beige",rgb:[255,197,165]},{id:53,premium:!0,name:"Dark Peach",rgb:[155,82,73]},{id:54,premium:!0,name:"Peach",rgb:[209,128,120]},{id:55,premium:!0,name:"Light Peach",rgb:[250,182,164]},{id:56,premium:!0,name:"Dark Tan",rgb:[123,99,82]},{id:57,premium:!0,name:"Tan",rgb:[156,132,107]},{id:58,premium:!0,name:"Dark Slate",rgb:[51,57,65]},{id:59,premium:!0,name:"Slate",rgb:[109,117,141]},{id:60,premium:!0,name:"Light Slate",rgb:[179,185,209]},{id:61,premium:!0,name:"Dark Stone",rgb:[109,100,63]},{id:62,premium:!0,name:"Stone",rgb:[148,140,107]},{id:63,premium:!0,name:"Light Stone",rgb:[205,197,158]}];function m(t,e){const n=(1e3*t[0]+e[0]+.5)/2048e3,i=1-(1e3*t[1]+e[1]+.5)/2048e3;return[360*Math.atan(Math.exp((2*i-1)*Math.PI))/Math.PI-90,360*n-180]}function u(t){t.width=0,t.height=0,t.constructor===HTMLCanvasElement&&t.remove(),t=null}var h,d,b,p,f,g,w=class{constructor({displayName:t="My template",R:e=0,A:n="",url:i="",file:s=null,coords:o=null,H:r=null,J:a=1e3}={}){this.displayName=t,this.R=e,this.A=n,this.url=i,this.file=s,this.coords=o,this.H=r,this.J=a,this.U=0,this.W=0,this.Y=0,this._={},this.V=new Set,this.X=null;const c=Array.isArray(l)?l:[];this.Z=new Set(c.filter(t=>"transparent"!==(t?.name||"").toLowerCase()&&Array.isArray(t?.rgb)).map(t=>`${t.rgb[0]},${t.rgb[1]},${t.rgb[2]}`));const m="222,250,206";this.Z.add(m);const u="other";this.Z.add(u),this.K=new Map(c.filter(t=>Array.isArray(t?.rgb)).map(t=>[`${t.rgb[0]},${t.rgb[1]},${t.rgb[2]}`,{id:t.id,premium:!!t.premium,name:t.name}]));try{const t=c.find(t=>"transparent"===(t?.name||"").toLowerCase());t&&Array.isArray(t.rgb)&&this.K.set(m,{id:t.id,premium:!!t.premium,name:t.name})}catch(t){}try{this.K.set(u,{id:"other",premium:!1,name:"Other"})}catch(t){}}tt(t,e,n){const i=n-1>>1;return(t%n==i||e%n==i)&&t%n>=i-1&&t%n<=i+1&&e%n>=i-1&&e%n<=i+1}et(t){const e=[];for(let n=0;n<t;n++)for(let i=0;i<t;i++)this.tt(i,n,t)&&e.push([i,n]);return e}nt(){let t=new OffscreenCanvas(5e3,5e3);const e=t.getContext("2d");e.fillRect(4999,4999,1,1);const n=0!==e.getImageData(4999,4999,1,1).data[3];return u(t),t=null,n}async it(){const t=this.nt()?5:4,e=await createImageBitmap(this.file),n=e.width,i=e.height,s=n*i;this.U=s;try{let t=new OffscreenCanvas(n,i);const s=t.getContext("2d",{willReadFrequently:!0});s.imageSmoothingEnabled=!1,s.clearRect(0,0,n,i),s.drawImage(e,0,0);const o=s.getImageData(0,0,n,i).data;u(t),t=null;let r=0,a=0;const c=new Map;for(let t=0;t<i;t++)for(let e=0;e<n;e++){const i=4*(t*n+e),s=o[i],l=o[i+1],m=o[i+2];if(0===o[i+3])continue;222===s&&250===l&&206===m&&a++;const u=this.Z.has(`${s},${l},${m}`)?`${s},${l},${m}`:"other";r++,c.set(u,(c.get(u)||0)+1)}this.W=r,this.Y=a;const l={};for(const[t,e]of c.entries())l[t]={count:e,enabled:!0};this._=l}catch(t){this.W=Math.max(0,this.U),this.Y=0}const o={},r={};let c=new OffscreenCanvas(this.J,this.J);const l=c.getContext("2d",{willReadFrequently:!0});for(let s=this.coords[3];s<i+this.coords[3];){const m=Math.min(this.J-s%this.J,i-(s-this.coords[3]));for(let i=this.coords[2];i<n+this.coords[2];){const h=Math.min(this.J-i%this.J,n-(i-this.coords[2])),d=h*t,b=m*t;c.width=d,c.height=b,l.imageSmoothingEnabled=!1,l.clearRect(0,0,d,b),l.drawImage(e,i-this.coords[2],s-this.coords[3],h,m,0,0,h*t,m*t);const p=l.getImageData(0,0,d,b);for(let e=0;e<b;e++)for(let n=0;n<d;n++){const i=4*(e*d+n);222===p.data[i]&&250===p.data[i+1]&&206===p.data[i+2]?((n+e)%2==0?(p.data[i]=0,p.data[i+1]=0,p.data[i+2]=0):(p.data[i]=255,p.data[i+1]=255,p.data[i+2]=255),p.data[i+3]=32):this.tt(n,e,t)||(p.data[i+3]=0)}l.putImageData(p,0,0);const f=`${(this.coords[0]+Math.floor(i/1e3)).toString().padStart(4,"0")},${(this.coords[1]+Math.floor(s/1e3)).toString().padStart(4,"0")},${(i%1e3).toString().padStart(3,"0")},${(s%1e3).toString().padStart(3,"0")}`;o[f]=await createImageBitmap(c),this.V.add(f.split(",").slice(0,2).join(","));const g=await c.convertToBlob(),w=await g.arrayBuffer(),y=Array.from(new Uint8Array(w));r[f]=a(y),u(c),c=null,i+=h}s+=m}return{st:o,ot:r}}};h=new WeakSet,d=async function(){GM.setValue("bmTemplates",JSON.stringify(this.rt))},b=async function(t){const e=t.templates;if(Object.keys(e).length>0){for(const t in e){const n=t,i=e[t];if(e.hasOwnProperty(t)){const t=n.split(" "),s=Number(t?.[0]),o=t?.[1]||"0",r=i.name||`Template ${s||""}`,a=i.tiles,l={};let m=0;const h=new Map;for(const t in a)if(a.hasOwnProperty(t)){const i=c(a[t]),s=new Blob([i],{type:"image/png"}),o=await createImageBitmap(s);l[t]=o;try{const t=o.width,i=o.height;let s=new OffscreenCanvas(t,i);const r=s.getContext("2d",{willReadFrequently:!0});r.imageSmoothingEnabled=!1,r.clearRect(0,0,t,i),r.drawImage(o,0,0);const a=r.getImageData(0,0,t,i).data;u(s),s=null;for(let s=this.ct;s<i;s+=this.lt)for(let i=this.ct;i<t;i+=this.lt){const o=4*(s*t+i),r=a[o],c=a[o+1],l=a[o+2];if(a[o+3]<64)continue;if(222===r&&250===c&&206===l)continue;m++;const u=Object.hasOwn(e[n].palette,`${r},${c},${l}`)?`${r},${c},${l}`:"other";h.set(u,(h.get(u)||0)+1)}}catch(t){}}const d=new w({displayName:r,R:s||this.ut?.length||0,A:o||""});d.H=l,d.W=m;const b={};for(const[t,e]of h.entries())b[t]={count:e,enabled:!0};d._=b;try{Object.keys(l).forEach(t=>{d.V?.add(t.split(",").slice(0,2).join(","))})}catch(t){}try{const t=e?.[n]?.palette;if(t)for(const[e,n]of Object.entries(t))d._[e]?d._[e].enabled=!!n?.enabled:d._[e]={count:n?.count||0,enabled:!!n?.enabled}}catch(t){}d.X=n,this.ut.push(d)}}try{const t=document.querySelector("#bm-4");t&&(t.style.display=""),window.postMessage({source:"blue-marble",ht:"bm-6"},"*")}catch(t){}}},p=new WeakSet,f=function(t){t.L("bm-n",`Charges: <b>${(new Intl.NumberFormat).format(Math.floor(this.dt()))} / ${(new Intl.NumberFormat).format(this.charges.max)}</b>`)},g=function(t){s(this,p,f).call(this,t),this.bt&&clearInterval(this.bt),this.bt=setInterval(()=>{s(this,p,f).call(this,t)},1e3)};var y=GM_info.script.name.toString(),v=GM_info.script.version.toString();!function(t){const e=document.createElement("script");e.setAttribute("bm-z",y),e.setAttribute("bm-w","color: cornflowerblue;"),e.textContent=`(${t})();`,document.documentElement?.appendChild(e),e.remove()}(()=>{const t=document.currentScript,e=t?.getAttribute("bm-z")||"Blue Marble",n=t?.getAttribute("bm-w")||"",i=new Map;window.addEventListener("message",t=>{const{source:s,endpoint:o,blobID:r,blobData:a,blink:c}=t.data;if(Date.now(),"blue-marble"==s&&r&&a&&!o){const t=i.get(r);"function"==typeof t?t(a):function(...t){(0,console.warn)(...t)}(`%c${e}%c: Attempted to retrieve a blob (%s) from queue, but the blobID was not a function! Skipping...`,n,"",r),i.delete(r)}});const s=window.fetch;window.fetch=async function(...t){const e=await s.apply(this,t),n=e.clone(),o=(t[0]instanceof Request?t[0]?.url:t[0])||"ignore",r=n.headers.get("content-type")||"";if(r.includes("application/json")){if(o.endsWith("/alliance/leaderboard/today")){const t=Date.now();return new Promise(e=>{const s=crypto.randomUUID();i.set(s,t=>{e(new Response(t,{headers:n.headers,status:n.status,statusText:n.statusText}))}),window.postMessage({source:"blue-marble",endpoint:o,blobID:s,blink:t})})}n.json().then(t=>{window.postMessage({source:"blue-marble",endpoint:o,jsonData:t},"*")}).catch(t=>{})}else if(r.includes("image/")&&!o.includes("openfreemap")&&!o.includes("maps")){const t=Date.now(),e=await n.blob();return new Promise(s=>{const r=crypto.randomUUID();i.set(r,t=>{s(new Response(t,{headers:n.headers,status:n.status,statusText:n.statusText}))}),window.postMessage({source:"blue-marble",endpoint:o,lastModified:n.headers.get("Last-Modified"),blobID:r,blobData:e,blink:t})}).catch(t=>{Date.now()})}return e}}),fetch("https://raw.githubusercontent.com/t-wy/Wplace-BlueMarble-Userscripts/refs/heads/custom-improve/dist/BlueMarble.user.css").then(t=>t.text()).then(GM.addStyle);var x=document.createElement("link");x.href="https://fonts.googleapis.com/css2?family=Roboto+Mono:ital,wght@0,100..700;1,100..700&display=swap",x.rel="preload",x.as="style",x.onload=function(){this.onload=null,this.rel="stylesheet"},document.head?.appendChild(x),new class{constructor(){this.ft=null,this.gt=null,this.wt="#bm-b"}yt(t){return this.gt=t,this.ft=new MutationObserver(t=>{for(const e of t)for(const t of e.addedNodes)t instanceof HTMLElement&&t.matches?.(this.wt)}),this}vt(){return this.ft}observe(t,e=!1,n=!1){t.observe(this.gt,{childList:e,subtree:n})}};var $=new o(y,v),M=(new o(y,v),new class{constructor(t,e,n){i(this,h),this.name=t,this.version=e,this.l=n,this.xt="1.0.0",this.$t=null,this.Mt="!#$%&'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[]^_`abcdefghijklmnopqrstuvwxyz{|}~",this.J=1e3;let s=new OffscreenCanvas(5e3,5e3);const o=s.getContext("2d");o.fillRect(4999,4999,1,1),0!==o.getImageData(4999,4999,1,1).data[3]?this.lt=5:this.lt=4,u(s),s=null,this.ct=this.lt-1>>1,this.Dt=null,this.kt=null,this.Ct="bm-x",this.Ot="div#map canvas.maplibregl-canvas",this.Nt=null,this.Tt="",this.ut=[],this.rt=null,this.It=!0,this.St=new Map}Lt(){if(document.body.contains(this.Dt))return this.Dt;document.getElementById(this.Ct)?.remove();const t=document.querySelector(this.Ot),e=document.createElement("canvas");return e.id=this.Ct,e.className="maplibregl-canvas",e.style.position="absolute",e.style.top="0",e.style.left="0",e.style.height=t?.clientHeight*(window.devicePixelRatio||1)+"px",e.style.width=t?.clientWidth*(window.devicePixelRatio||1)+"px",e.height=t?.clientHeight*(window.devicePixelRatio||1),e.width=t?.clientWidth*(window.devicePixelRatio||1),e.style.zIndex="8999",e.style.pointerEvents="none",t?.parentElement?.appendChild(e),this.Dt=e,window.addEventListener("move",this.Bt),window.addEventListener("zoom",this.jt),window.addEventListener("resize",this.Gt),this.Dt}async Pt(){return{whoami:this.name.replace(" ",""),scriptVersion:this.version,schemaVersion:this.xt,templates:{}}}async qt(t,e,n){this.rt||(this.rt=await this.Pt()),this.l.F(`Creating template at ${n.join(", ")}...`);const i=new w({displayName:e,R:0,A:r(this.$t||0,this.Mt),file:t,coords:n}),{st:o,ot:a}=await i.it(this.J);i.H=o;const c=`${i.R} ${i.A}`;i.X=c,this.rt.templates[c]={name:i.displayName,coords:n.join(", "),enabled:!0,tiles:a,palette:i._},this.ut=[],this.ut.push(i);const l=(new Intl.NumberFormat).format(i.U);this.l.F(`Template created at ${n.join(", ")}! Total pixels: ${l}`);try{const t=document.querySelector("#bm-4");t&&(t.style.display=""),window.postMessage({source:"blue-marble",ht:"bm-6"},"*")}catch(t){}await s(this,h,d).call(this)}Et(){}async Ft(){this.rt||(this.rt=await this.Pt())}async Rt(t,e){if(!this.It)return t;const n=this.J*this.lt,i=e;e=e[0].toString().padStart(4,"0")+","+e[1].toString().padStart(4,"0");const s=this.ut;if(s.sort((t,e)=>t.R-e.R),!s.some(t=>!!t?.H&&(t.V&&t.V.size>0?t.V.has(e):Object.keys(t.H).some(t=>t.startsWith(e)))))return t;const o=s.map(t=>{const n=Object.keys(t.H).filter(t=>t.startsWith(e));if(0===n.length)return null;const i=n.map(e=>{const n=e.split(",");return{At:t.H[e],zt:[n[0],n[1]],Ht:[n[2],n[3]]}});return i?.[0]}).filter(Boolean),r=o?.length||0;let a=0,c=0,m=0,h={};const d=await createImageBitmap(t);let b=new OffscreenCanvas(n,n);const p=b.getContext("2d");p.imageSmoothingEnabled=!1,p.beginPath(),p.rect(0,0,n,n),p.clip(),p.clearRect(0,0,n,n),p.drawImage(d,0,0,n,n);let f=null;try{f=p.getImageData(0,0,n,n).data}catch(t){}const g=Object.fromEntries(l.map(t=>{const[e,n,i]=t.rgb;return[`${e},${n},${i}`,t]}));for(const t of o){if(f)try{const e=t.At.width,s=t.At.height;let o=new OffscreenCanvas(e,s);const r=o.getContext("2d",{willReadFrequently:!0});r.imageSmoothingEnabled=!1,r.clearRect(0,0,e,s),r.drawImage(t.At,0,0);const l=r.getImageData(0,0,e,s).data;u(o),o=null;const d=Number(t.Ht[0])*this.lt,b=Number(t.Ht[1])*this.lt;for(let t=this.ct;t<s;t+=this.lt)for(let s=this.ct;s<e;s+=this.lt){const o=s+d,r=t+b;if(o<0||r<0||o>=n||r>=n)continue;const u=4*(t*e+s),p=l[u],w=l[u+1],y=l[u+2];if(l[u+3]<64){try{const t=this.ut?.[0],e=4*(r*n+o),i=f[e],s=f[e+1],a=f[e+2],l=f[e+3],m=t.Z.has(`${i},${s},${a}`)?`${i},${s},${a}`:"other",u=!!t?.Z&&t.Z.has(m);l>=64&&u&&c++}catch(t){}continue}m++;const v=4*(r*n+o),x=f[v],$=f[v+1],M=f[v+2],D=f[v+3];let k=!1;if(D<64||(x===p&&$===w&&M===y?(a++,k=!0):c++),!k){let t=`${p},${w},${y}`;void 0===g[t]&&(t="other");const e=[i,[Math.floor(o/this.lt),Math.floor(r/this.lt)]];if(void 0===h[t])h[t]={missing:1,examples:[e]};else{const n=100;if(h[t].missing++,h[t].examples.length<n)h[t].examples.push(e);else if(Math.random()*h[t].missing<n){const i=Math.floor(Math.random()*n);h[t].examples[i]=e}}}}}catch(t){}try{const e=this.ut?.[0],n=e?._||{};if(Object.values(n).some(t=>!1===t?.enabled)){const i=t.At.width,s=t.At.height;let o=new OffscreenCanvas(i,s);const r=o.getContext("2d",{willReadFrequently:!0});r.imageSmoothingEnabled=!1,r.clearRect(0,0,i,s),r.drawImage(t.At,0,0);const a=r.getImageData(0,0,i,s),c=a.data;for(const[t,o]of e.et(this.lt))for(let r=o;r<s;r+=this.lt)for(let s=t;s<i;s+=this.lt){const t=4*(r*i+s),o=c[t],a=c[t+1],l=c[t+2];if(c[t+3]<1)continue;let m=e.Z.has(`${o},${a},${l}`)?`${o},${a},${l}`:"other";(!e?.Z||e.Z.has(m))&&!1!==n?.[m]?.enabled||(c[t+3]=0)}r.putImageData(a,0,0),p.drawImage(o,Number(t.Ht[0])*this.lt,Number(t.Ht[1])*this.lt),u(o),o=null}else p.drawImage(t.At,Number(t.Ht[0])*this.lt,Number(t.Ht[1])*this.lt)}catch(e){p.drawImage(t.At,Number(t.Ht[0])*this.lt,Number(t.Ht[1])*this.lt)}}if(r>0){const t=e;this.St.set(t,{Jt:a,required:m,Ut:c,palette:h});let n=0,i=0,s=0;for(const t of this.St.values())n+=t.Jt||0,i+=t.required||0,s+=t.Ut||0;const o=this.ut.reduce((t,e)=>t+(e.W||e.U||0),0),l=o>0?o:i,u=(new Intl.NumberFormat).format(n),d=(new Intl.NumberFormat).format(l),b=(new Intl.NumberFormat).format(l-n);this.l.F(`Displaying ${r} template${1==r?"":"s"}.\nPainted ${u} / ${d} • Wrong ${b}`)}else this.l.F(`Displaying ${r} templates.`);const w=await b.convertToBlob({type:"image/png"});return u(b),b=null,w}Wt(t){"BlueMarble"==t?.whoami&&(this.rt=t,s(this,h,b).call(this,t))}Yt(t){this.It=t}}(y,v,$)),D=new class{constructor(t){i(this,p),this._t=t,this.Vt=!1,this.Xt=[],this.Zt=[],this.charges=null,this.Kt=null,this.bt=null,this.Qt={}}dt(){const t=(Date.now()-this.Kt)/this.charges.cooldownMs,e=this.charges.count+t,n=this.charges.count>this.charges.max?this.charges.count:this.charges.max;return e>n?n:e}te(t){window.addEventListener("message",async e=>{const n=e.data,i=n.jsonData;if(!n||"blue-marble"!==n.source)return;if(!n.endpoint)return;const o=n.endpoint?.split("?")[0].split("/").filter(t=>t&&isNaN(Number(t))).filter(t=>t&&!t.includes(".")).pop();switch(o){case"me":if(i.status&&"2"!=i.status?.toString()[0])return void t.q("You are not logged in!\nCould not fetch userdata.");const e=Math.ceil(Math.pow(Math.floor(i.level)*Math.pow(30,.65),1/.65)-i.pixelsPainted);i.id||i.id,this._t.$t=i.id,this.charges=i.charges,this.Kt=Date.now(),t.L("bm-p",`Username: <b>${function(t){const e=document.createElement("div");return e.textContent=t,e.innerHTML}(i.name)}</b>`),s(this,p,g).call(this,t),t.L("bm-j",`Droplets: <b>${(new Intl.NumberFormat).format(i.droplets)}</b>`),t.L("bm-c",`Next level in <b>${(new Intl.NumberFormat).format(e)}</b> pixel${1==e?"":"s"}`);break;case"pixel":const o=n.endpoint.split("?")[0].split("/").filter(t=>t&&!isNaN(Number(t))).map(t=>Number(t)),c=new URLSearchParams(n.endpoint.split("?")[1]),u=[+c.get("x"),+c.get("y")];if(this.Xt.length&&(!o.length||!u.length))return void t.q("Coordinates are malformed!\nDid you try clicking the canvas first?");this.Xt=[...o,...u];const h=(r=o,a=u,[parseInt(r[0])%4*1e3+parseInt(a[0]),parseInt(r[1])%4*1e3+parseInt(a[1])]),d=document.querySelectorAll("span");for(const t of d)if(t.textContent.trim().includes(`${h[0]}, ${h[1]}`)){let e=document.querySelector("#bm-b"),n=document.querySelector("#bm-a");const i=m(o,u),s=`(Tl X: ${o[0]}, Tl Y: ${o[1]}, Px X: ${u[0]}, Px Y: ${u[1]})`,r=`(${i[0].toFixed(5)}, ${i[1].toFixed(5)})`;if(e)e.textContent=s,n.textContent=r;else{e=document.createElement("span"),e.id="bm-b",e.textContent=s,e.style="margin-left: calc(var(--spacing)*3); font-size: small;",t.parentNode.parentNode.parentNode.insertAdjacentElement("afterend",e);const i=document.createElement("br");e.insertAdjacentElement("afterend",i),n=document.createElement("span"),n.id="bm-a",n.textContent=r,n.style="margin-left: calc(var(--spacing)*3); font-size: small;",i.insertAdjacentElement("afterend",n)}}break;case"tiles":let b=n.endpoint.split("/");b=[parseInt(b[b.length-2]),parseInt(b[b.length-1].replace(".png",""))];const f=n.blobID,w=n.blobData,y=b[0].toString().padStart(4,"0")+","+b[1].toString().padStart(4,"0"),v=n.lastModified,x=this._t.ut?.[0],$=x?._||{},M=Object.keys($).filter(t=>!1!==$[t]?.enabled).sort().join("|"),D=Object.keys(x?.H||{}).sort().join("|");let k=null;this.Qt[y]&&this.Qt[y][0]===v&&this.Qt[y][1]===M&&this.Qt[y][2]===D&&(k=this.Qt[y][3]),null===k&&(k=await this._t.Rt(w,b),this._t.It&&this._t.ut.some(t=>!!t?.H&&(t.V&&t.V.size>0?t.V.has(y):Object.keys(t.H).some(t=>t.startsWith(y))))&&(this.Qt[y]=[v,M,D,k])),window.postMessage({source:"blue-marble",blobID:f,blobData:k,blink:n.blink});break;case"today":const C=n.blobID,O=this._t.ut?.[0],N=O?._||{},T={};for(const t of this._t.St.values())Object.entries(t.palette).forEach(([t,e])=>{void 0===T[t]?(T[t]=e,T[t].examples=e.examples.slice()):(T[t].missing+=e.missing,T[t].examples.push(...e.examples))});const I=Object.fromEntries(l.map(t=>{const[e,n,i]=t.rgb;return[`${e},${n},${i}`,t]})),S=Object.keys(N).filter(t=>void 0!==T[t]).map(t=>{const e=T[t],n=Math.floor(Math.random()*e.examples.length),i=m(e.examples[n][0],e.examples[n][1]);return{userId:-(I[t]?.id??999),name:I[t]?.name??t,equippedFlag:0,pixelsPainted:-e.missing,lastLatitude:i[0],lastLongitude:i[1]}}).sort((t,e)=>t.pixelsPainted-e.pixelsPainted);window.postMessage({source:"blue-marble",blobID:C,blobData:JSON.stringify(S),blink:n.blink});break;case"robots":this.Vt="false"==i.userscript?.toString().toLowerCase()}var r,a})}}(M);$.h(D),GM.getValue("bmTemplates","{}").then(t=>{const e=JSON.parse(t);M.Wt(e)}).then(()=>GM.getValue("bmUserSettings","{}").then(t=>{const e=JSON.parse(t);if(0==Object.keys(e).length){const t=crypto.randomUUID();GM.setValue("bmUserSettings",JSON.stringify({uuid:t}))}})).then(()=>function(){let t=!1,e={};return GM.getValue("bmCoords","{}").then(t=>{e=JSON.parse(t)||{}}).catch(()=>{e={}}).finally(()=>{const n=()=>{try{const t=Number(document.querySelector("#bm-q")?.value||""),e=Number(document.querySelector("#bm-r")?.value||""),n={tx:t,ty:e,px:Number(document.querySelector("#bm-s")?.value||""),py:Number(document.querySelector("#bm-t")?.value||"")};GM.setValue("bmCoords",JSON.stringify(n))}catch(t){}};$.$({id:"bm-v",style:"top: 10px; right: 75px;"}).$({id:"bm-d"}).$({id:"bm-u"}).p().k({alt:"Blue Marble Icon - Click to minimize/maximize",src:"https://raw.githubusercontent.com/SwingTheVine/Wplace-BlueMarble/main/dist/assets/Favicon.png",style:"cursor: pointer;"},(e,n)=>{n.addEventListener("click",()=>{t=!t;const i=document.querySelector("#bm-v"),s=document.querySelector("#bm-d"),o=document.querySelector("#bm-u"),r=document.querySelector("#bm-e"),a=document.querySelector("#bm-k"),c=document.querySelector("#bm-l"),l=document.querySelector("#bm-m"),m=document.querySelector("#bm-f"),u=document.querySelectorAll("#bm-e input");t||(i.style.width="auto",i.style.maxWidth="300px",i.style.minWidth="200px",i.style.padding="10px"),["#bm-v h1","#bm-8","#bm-v hr","#bm-7 > *:not(#bm-e)","#bm-5","#bm-3",`#${e.o}`,"#bm-4"].forEach(e=>{document.querySelectorAll(e).forEach(e=>{e.style.display=t?"none":""})}),t?(r&&(r.style.display="none"),a&&(a.style.display="none"),c&&(c.style.display="none"),l&&(l.style.display="none"),m&&(m.style.display="none"),u.forEach(t=>{t.style.display="none"}),i.style.width="60px",i.style.height="76px",i.style.maxWidth="60px",i.style.minWidth="60px",i.style.padding="8px",n.style.marginLeft="3px",s.style.textAlign="center",s.style.margin="0",s.style.marginBottom="0",o&&(o.style.display="",o.style.marginBottom="0.25em")):(r&&(r.style.display="",r.style.flexDirection="",r.style.justifyContent="",r.style.alignItems="",r.style.gap="",r.style.textAlign="",r.style.margin=""),a&&(a.style.display=""),c&&(c.style.display="",c.style.marginTop=""),l&&(l.style.display="",l.style.marginTop=""),m&&(m.style.display="",m.style.marginTop=""),u.forEach(t=>{t.style.display=""}),n.style.marginLeft="",i.style.padding="10px",s.style.textAlign="",s.style.margin="",s.style.marginBottom="",o&&(o.style.marginBottom="0.5em"),i.style.width="",i.style.height=""),n.alt=t?"Blue Marble Icon - Minimized (Click to maximize)":"Blue Marble Icon - Maximized (Click to minimize)"})}).p().C(1,{textContent:y}).p().p().O().p().$({id:"bm-8"}).M({id:"bm-p",textContent:"Username:"}).p().M({id:"bm-n",textContent:"Charges:"}).p().M({id:"bm-j",textContent:"Droplets:"}).p().M({id:"bm-c",textContent:"Next level in..."}).p().p().O().p().$({id:"bm-7"}).$({id:"bm-e"}).I({id:"bm-k",className:"bm-y",style:"margin-top: 0;",innerHTML:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 4 6"><circle cx="2" cy="2" r="2"></circle><path d="M2 6 L3.7 3 L0.3 3 Z"></path><circle cx="2" cy="2" r="0.7" fill="white"></circle></svg></svg>'},(t,e)=>{e.onclick=()=>{const e=t.i?.Xt;e?.[0]?(t.L("bm-q",e?.[0]||""),t.L("bm-r",e?.[1]||""),t.L("bm-s",e?.[2]||""),t.L("bm-t",e?.[3]||""),n()):t.q("Coordinates are malformed! Did you try clicking on the canvas first?")}}).p().B({type:"number",id:"bm-q",placeholder:"Tl X",min:0,max:2047,step:1,required:!0,value:e.tx??""},(t,e)=>{e.addEventListener("paste",t=>{let e=(t.clipboardData||window.clipboardData).getData("text").split(" ").filter(t=>t).map(Number).filter(t=>!isNaN(t));if(4!==e.length)return;let n=(i=document,coords=[],coords.push(i.querySelector("#bm-q")),coords.push(i.querySelector("#bm-r")),coords.push(i.querySelector("#bm-s")),coords.push(i.querySelector("#bm-t")),coords);var i;for(let t=0;t<n.length;t++)n[t].value=e[t];t.preventDefault()});const i=()=>n();e.addEventListener("input",i),e.addEventListener("change",i)}).p().B({type:"number",id:"bm-r",placeholder:"Tl Y",min:0,max:2047,step:1,required:!0,value:e.ty??""},(t,e)=>{const i=()=>n();e.addEventListener("input",i),e.addEventListener("change",i)}).p().B({type:"number",id:"bm-s",placeholder:"Px X",min:0,max:2047,step:1,required:!0,value:e.px??""},(t,e)=>{const i=()=>n();e.addEventListener("input",i),e.addEventListener("change",i)}).p().B({type:"number",id:"bm-t",placeholder:"Px Y",min:0,max:2047,step:1,required:!0,value:e.py??""},(t,e)=>{const i=()=>n();e.addEventListener("input",i),e.addEventListener("change",i)}).p().p().$({id:"bm-4",style:"max-height: 140px; overflow: auto; border: 1px solid rgba(255,255,255,0.1); padding: 4px; border-radius: 4px; display: none;"}).$({style:"display: flex; gap: 6px; margin-bottom: 6px;"}).I({id:"bm-1",textContent:"Enable All"},(t,e)=>{e.onclick=()=>{const e=M.ut[0];e?._&&(Object.values(e._).forEach(t=>t.enabled=!0),buildColorFilterList(),t.F("Enabled all colors"))}}).p().I({id:"bm-0",textContent:"Disable All"},(t,e)=>{e.onclick=()=>{const e=M.ut[0];e?._&&(Object.values(e._).forEach(t=>t.enabled=!1),buildColorFilterList(),t.F("Disabled all colors"))}}).p().p().$({id:"bm-9"}).p().p().j({id:"bm-5",textContent:"Upload Template",accept:"image/png, image/jpeg, image/webp, image/bmp, image/gif"}).p().$({id:"bm-2"}).I({id:"bm-m",textContent:"Enable"},(t,e)=>{e.onclick=()=>{t.i?._t?.Yt(!0),t.F("Enabled templates!")}}).p().I({id:"bm-l",textContent:"Create"},(t,e)=>{e.onclick=()=>{const e=document.querySelector("#bm-5"),n=document.querySelector("#bm-q");if(!n.checkValidity())return n.reportValidity(),void t.q("Coordinates are malformed! Did you try clicking on the canvas first?");const i=document.querySelector("#bm-r");if(!i.checkValidity())return i.reportValidity(),void t.q("Coordinates are malformed! Did you try clicking on the canvas first?");const s=document.querySelector("#bm-s");if(!s.checkValidity())return s.reportValidity(),void t.q("Coordinates are malformed! Did you try clicking on the canvas first?");const o=document.querySelector("#bm-t");if(!o.checkValidity())return o.reportValidity(),void t.q("Coordinates are malformed! Did you try clicking on the canvas first?");e?.files[0]?(M.qt(e.files[0],e.files[0]?.name.replace(/\.[^/.]+$/,""),[Number(n.value),Number(i.value),Number(s.value),Number(o.value)]),t.F("Drew to canvas!")):t.q("No file selected!")}}).p().I({id:"bm-f",textContent:"Disable"},(t,e)=>{e.onclick=()=>{t.i?._t?.Yt(!1),t.F("Disabled templates!")}}).p().p().G({id:$.o,placeholder:`Status: Sleeping...\nVersion: ${v}`,readOnly:!0}).p().$({id:"bm-3"}).$().I({id:"bm-g",className:"bm-y",innerHTML:"🎨",title:"Template Color Converter"},(t,e)=>{e.addEventListener("click",()=>{window.open("https://pepoafonso.github.io/color_converter_wplace/","_blank","noopener noreferrer")})}).p().I({id:"bm-h",className:"bm-y",innerHTML:"🌐",title:"Official Blue Marble Website"},(t,e)=>{e.addEventListener("click",()=>{window.open("https://bluemarble.camilledaguin.fr/","_blank","noopener noreferrer")})}).p().p().D({textContent:`v${v} by SwingTheVine`,style:"margin-top: auto;"}).p().p().p().v(document.body),window.buildColorFilterList=function(){const t=document.querySelector("#bm-9"),e=M.ut?.[0];if(!t||!e?._)return void(t&&(t.innerHTML="<small>No template colors to display.</small>"));t.innerHTML="";const n=Object.entries(e._).sort((t,e)=>e[1].count-t[1].count);for(const[e,i]of n){let n=document.createElement("div");n.style.display="flex",n.style.alignItems="center",n.style.gap="8px",n.style.margin="4px 0";let s=document.createElement("div");s.style.width="14px",s.style.height="14px",s.style.border="1px solid rgba(255,255,255,0.5)";let o=document.createElement("span");o.style.fontSize="12px";let r=`${i.count.toLocaleString()}`;if("other"===e)s.style.background="#888",r=`Other • ${r}`;else if("#deface"===e)s.style.background="#deface",r=`Transparent • ${r}`;else{const[t,n,i]=e.split(",").map(Number);s.style.background=`rgb(${t},${n},${i})`;try{const s=M.ut?.[0]?.K?.get(e);if(s&&"number"==typeof s.id){const e=s?.name||`rgb(${t},${n},${i})`,o=s.premium?"★ ":"";r=`#${s.id} ${o}${e} • ${r}`}}catch(t){}}o.textContent=r;const a=document.createElement("input");a.type="checkbox",a.checked=!!i.enabled,a.addEventListener("change",()=>{i.enabled=a.checked,$.F(`${a.checked?"Enabled":"Disabled"} ${e}`);try{const t=M.ut?.[0],e=t?.X;t&&e&&M.rt?.templates?.[e]&&(M.rt.templates[e].palette=t._,GM.setValue("bmTemplates",JSON.stringify(M.rt)))}catch(t){}}),n.appendChild(a),n.appendChild(s),n.appendChild(o),t.appendChild(n)}},window.addEventListener("message",t=>{if("bm-6"===t?.data?.ht)try{buildColorFilterList()}catch(t){}}),setTimeout(()=>{try{if(M.ut?.length>0){const t=document.querySelector("#bm-4");t&&(t.style.display=""),buildColorFilterList()}}catch(t){}},0)})}()).then(()=>{$.P("#bm-v","#bm-u"),D.te($),new MutationObserver((t,e)=>{const n=document.querySelector("#color-1");if(!n)return;let i=document.querySelector("#bm-o");if(!i){i=document.createElement("button"),i.id="bm-o",i.textContent="Move ↑",i.className="btn btn-soft",i.onclick=function(){const t=this.parentNode.parentNode.parentNode.parentNode,e="Move ↑"==this.textContent;t.parentNode.className=t.parentNode.className.replace(e?"bottom":"top",e?"top":"bottom"),t.style.borderTopLeftRadius=e?"0px":"var(--radius-box)",t.style.borderTopRightRadius=e?"0px":"var(--radius-box)",t.style.borderBottomLeftRadius=e?"var(--radius-box)":"0px",t.style.borderBottomRightRadius=e?"var(--radius-box)":"0px",this.textContent=e?"Move ↓":"Move ↑"};const t=n.parentNode.parentNode.parentNode.parentNode.querySelector("h2");t.parentNode?.appendChild(i)}}).observe(document.body,{childList:!0,subtree:!0}),function(...t){(0,console.log)(...t)}(`%c${y}%c (${v}) userscript has loaded!`,"color: cornflowerblue;","")})})();