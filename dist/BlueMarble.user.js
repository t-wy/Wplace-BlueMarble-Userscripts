// ==UserScript==
// @name         Blue Marble
// @namespace    https://github.com/SwingTheVine/
// @version      0.85.22
// @description  A userscript to automate and/or enhance the user experience on Wplace.live. Make sure to comply with the site's Terms of Service, and rules! This script is not affiliated with Wplace.live in any way, use at your own risk. This script is not affiliated with TamperMonkey. The author of this userscript is not responsible for any damages, issues, loss of data, or punishment that may occur as a result of using this script. This script is provided "as is" under the MPL-2.0 license. The "Blue Marble" icon is licensed under CC0 1.0 Universal (CC0 1.0) Public Domain Dedication. The image is owned by NASA.
// @author       SwingTheVine / TWY
// @license      MPL-2.0
// @supportURL   https://discord.gg/tpeBPy46hf
// @homepageURL  https://bluemarble.camilledaguin.fr/
// @icon         https://raw.githubusercontent.com/t-wy/Wplace-BlueMarble-Userscripts/74b1a6fdf2e7bb275a8a147addb64eaad2892ab1/dist/assets/Favicon.png
// @updateURL    https://raw.githubusercontent.com/t-wy/Wplace-BlueMarble-Userscripts/custom-improve/dist/BlueMarble.user.js
// @downloadURL  https://raw.githubusercontent.com/t-wy/Wplace-BlueMarble-Userscripts/custom-improve/dist/BlueMarble.user.js
// @match        https://wplace.live/*
// @run-at       document-start
// @grant        GM.addStyle
// @grant        GM.setValue
// @grant        GM.getValue
// @grant        GM_xmlhttpRequest
// ==/UserScript==

// Wplace  --> https://wplace.live
// License --> https://www.mozilla.org/en-US/MPL/2.0/

(()=>{var t,e,n=t=>{throw TypeError(t)},i=(t,e,i)=>e.has(t)?n("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(t):e.set(t,i),o=(t,e,i)=>(((t,e)=>{e.has(t)||n("Cannot access private method")})(t,e),i);function s(...t){(0,console.log)(...t)}function r(t,e){if(0===t)return e[0];let n="";const i=e.length;for(;t>0;)n=e[t%i]+n,t=Math.floor(t/i);return n}function a(t){let e="";for(let n=0;n<t.length;n++)e+=String.fromCharCode(t[n]);return btoa(e)}function c(t){const e=atob(t),n=new Uint8Array(e.length);for(let t=0;t<e.length;t++)n[t]=e.charCodeAt(t);return n}window.OffscreenCanvas||(window.OffscreenCanvas=function(t,e){const n=document.createElement("canvas");return n.width=t,n.height=e,n.convertToBlob=function({type:t,t:e}={}){return new Promise((i,o)=>{n.toBlob(t=>{t?i(t):o(new Error("toBlob() returned null"))},t,e)})},n}),t=new WeakSet,e=function(t,e={},n={}){const i=document.createElement(t);this.i?(this.o?.appendChild(i),this.l.push(this.o),this.o=i):(this.i=i,this.o=i);for(const[t,n]of Object.entries(e))i[t]=n;for(const[t,e]of Object.entries(n))i[t]=e;return i};var l=[{id:0,premium:!1,name:"Transparent",rgb:[0,0,0]},{id:1,premium:!1,name:"Black",rgb:[0,0,0]},{id:2,premium:!1,name:"Dark Gray",rgb:[60,60,60]},{id:3,premium:!1,name:"Gray",rgb:[120,120,120]},{id:4,premium:!1,name:"Light Gray",rgb:[210,210,210]},{id:5,premium:!1,name:"White",rgb:[255,255,255]},{id:6,premium:!1,name:"Deep Red",rgb:[96,0,24]},{id:7,premium:!1,name:"Red",rgb:[237,28,36]},{id:8,premium:!1,name:"Orange",rgb:[255,127,39]},{id:9,premium:!1,name:"Gold",rgb:[246,170,9]},{id:10,premium:!1,name:"Yellow",rgb:[249,221,59]},{id:11,premium:!1,name:"Light Yellow",rgb:[255,250,188]},{id:12,premium:!1,name:"Dark Green",rgb:[14,185,104]},{id:13,premium:!1,name:"Green",rgb:[19,230,123]},{id:14,premium:!1,name:"Light Green",rgb:[135,255,94]},{id:15,premium:!1,name:"Dark Teal",rgb:[12,129,110]},{id:16,premium:!1,name:"Teal",rgb:[16,174,166]},{id:17,premium:!1,name:"Light Teal",rgb:[19,225,190]},{id:18,premium:!1,name:"Dark Blue",rgb:[40,80,158]},{id:19,premium:!1,name:"Blue",rgb:[64,147,228]},{id:20,premium:!1,name:"Cyan",rgb:[96,247,242]},{id:21,premium:!1,name:"Indigo",rgb:[107,80,246]},{id:22,premium:!1,name:"Light Indigo",rgb:[153,177,251]},{id:23,premium:!1,name:"Dark Purple",rgb:[120,12,153]},{id:24,premium:!1,name:"Purple",rgb:[170,56,185]},{id:25,premium:!1,name:"Light Purple",rgb:[224,159,249]},{id:26,premium:!1,name:"Dark Pink",rgb:[203,0,122]},{id:27,premium:!1,name:"Pink",rgb:[236,31,128]},{id:28,premium:!1,name:"Light Pink",rgb:[243,141,169]},{id:29,premium:!1,name:"Dark Brown",rgb:[104,70,52]},{id:30,premium:!1,name:"Brown",rgb:[149,104,42]},{id:31,premium:!1,name:"Beige",rgb:[248,178,119]},{id:32,premium:!0,name:"Medium Gray",rgb:[170,170,170]},{id:33,premium:!0,name:"Dark Red",rgb:[165,14,30]},{id:34,premium:!0,name:"Light Red",rgb:[250,128,114]},{id:35,premium:!0,name:"Dark Orange",rgb:[228,92,26]},{id:36,premium:!0,name:"Light Tan",rgb:[214,181,148]},{id:37,premium:!0,name:"Dark Goldenrod",rgb:[156,132,49]},{id:38,premium:!0,name:"Goldenrod",rgb:[197,173,49]},{id:39,premium:!0,name:"Light Goldenrod",rgb:[232,212,95]},{id:40,premium:!0,name:"Dark Olive",rgb:[74,107,58]},{id:41,premium:!0,name:"Olive",rgb:[90,148,74]},{id:42,premium:!0,name:"Light Olive",rgb:[132,197,115]},{id:43,premium:!0,name:"Dark Cyan",rgb:[15,121,159]},{id:44,premium:!0,name:"Light Cyan",rgb:[187,250,242]},{id:45,premium:!0,name:"Light Blue",rgb:[125,199,255]},{id:46,premium:!0,name:"Dark Indigo",rgb:[77,49,184]},{id:47,premium:!0,name:"Dark Slate Blue",rgb:[74,66,132]},{id:48,premium:!0,name:"Slate Blue",rgb:[122,113,196]},{id:49,premium:!0,name:"Light Slate Blue",rgb:[181,174,241]},{id:50,premium:!0,name:"Light Brown",rgb:[219,164,99]},{id:51,premium:!0,name:"Dark Beige",rgb:[209,128,81]},{id:52,premium:!0,name:"Light Beige",rgb:[255,197,165]},{id:53,premium:!0,name:"Dark Peach",rgb:[155,82,73]},{id:54,premium:!0,name:"Peach",rgb:[209,128,120]},{id:55,premium:!0,name:"Light Peach",rgb:[250,182,164]},{id:56,premium:!0,name:"Dark Tan",rgb:[123,99,82]},{id:57,premium:!0,name:"Tan",rgb:[156,132,107]},{id:58,premium:!0,name:"Dark Slate",rgb:[51,57,65]},{id:59,premium:!0,name:"Slate",rgb:[109,117,141]},{id:60,premium:!0,name:"Light Slate",rgb:[179,185,209]},{id:61,premium:!0,name:"Dark Stone",rgb:[109,100,63]},{id:62,premium:!0,name:"Stone",rgb:[148,140,107]},{id:63,premium:!0,name:"Light Stone",rgb:[205,197,158]}],m=new Set(l.filter(t=>"transparent"!==(t?.name||"").toLowerCase()&&Array.isArray(t?.rgb)).map(t=>`${t.rgb[0]},${t.rgb[1]},${t.rgb[2]}`)),u="222,250,206";m.add(u);var d="other";m.add(d);var h=new Map(l.filter(t=>Array.isArray(t?.rgb)).map(t=>[`${t.rgb[0]},${t.rgb[1]},${t.rgb[2]}`,{id:t.id,premium:!!t.premium,name:t.name}]));try{const t=l.find(t=>"transparent"===(t?.name||"").toLowerCase());t&&Array.isArray(t.rgb)&&h.set(u,{id:t.id,premium:!!t.premium,name:t.name})}catch(t){}try{h.set(d,{id:"other",premium:!1,name:"Other"})}catch(t){}function b(t,e){const n=(1e3*t[0]+e[0]+.5)/2048e3,i=1-(1e3*t[1]+e[1]+.5)/2048e3;return[360*Math.atan(Math.exp((2*i-1)*Math.PI))/Math.PI-90,360*n-180]}function p(t){t.width=0,t.height=0,t.constructor===HTMLCanvasElement&&t.remove(),t=null}function f(t,e,n=!0){const i=b(t,e);!function(t,e,n=!0){const i=document.querySelector(".flex>.btn.btn-square.relative.shadow-md");let o=null;if(null!==i&&n)if(void 0!==i.__click){const t=null===i?null:i.__click[1].reactions[0].ctx.s.onlastpixelclick;o=(e,n)=>t({lat:e,lng:n})}else o=(t,e)=>{const n=document.createElement("script");n.setAttribute("bm-J",t),n.setAttribute("bm-K",e),n.textContent=`(${()=>{const t=document.currentScript,e=+t.getAttribute("bm-J"),n=+t.getAttribute("bm-K");document.querySelector(".flex>.btn.btn-square.relative.shadow-md").__click[1].reactions[0].ctx.s.onlastpixelclick({lat:e,lng:n})}})();`,document.documentElement?.appendChild(n),n.remove()};else{const t=document.querySelector(".right-3>button"),e=n?"flyTo":"jumpTo";if(null!==t)if(void 0!==t.__click){const n=t.__click[3].v;null!==n&&"string"==typeof n.version&&(o=(t,i)=>n[e]({center:[i,t],zoom:16}))}else o=(t,n)=>{const i=document.createElement("script");i.setAttribute("bm-J",t),i.setAttribute("bm-K",n),i.setAttribute("bm-x",e),i.textContent=`(${()=>{const t=document.currentScript,e=+t.getAttribute("bm-J"),n=+t.getAttribute("bm-K"),i=t.getAttribute("bm-x");document.querySelector(".right-3>button").__click[3].v[i]({center:[n,e],zoom:16})}})();`,document.documentElement?.appendChild(i),i.remove()}}if(null!==o)o(t,e);else{const n=`https://wplace.live/?lat=${t}&lng=${e}&zoom=14`;window.location.href=n}}(i[0],i[1],n)}function g(){return[[Number(document.querySelector("#bm-y")?.value||""),Number(document.querySelector("#bm-z")?.value||"")],[Number(document.querySelector("#bm-A")?.value||""),Number(document.querySelector("#bm-B")?.value||"")]]}var w,y,v,$,x,M,k=class{constructor({displayName:t="My template",m:e=0,u:n="",url:i="",file:o=null,coords:s=null,h:r=null,p:a=1e3}={}){this.displayName=t,this.m=e,this.u=n,this.url=i,this.file=o,this.coords=s,this.h=r,this.p=a,this.enabled=!0,this.$=0,this.M=0,this.k=0,this.C={},this.T=new Set,this.D=null,Array.isArray(l),this.O=m,this.L=h,this.N=null}S(t,e,n){const i=n-1>>1;return(t%n==i||e%n==i)&&t%n>=i-1&&t%n<=i+1&&e%n>=i-1&&e%n<=i+1}I(t){const e=[];for(let n=0;n<t;n++)for(let i=0;i<t;i++)this.S(i,n,t)&&e.push([i,n]);return e}B(){let t=new OffscreenCanvas(5e3,5e3);const e=t.getContext("2d");e.fillRect(4999,4999,1,1);const n=0!==e.getImageData(4999,4999,1,1).data[3];return p(t),t=null,n}async j(){null===this.N&&(this.N=this.B()?5:4);const t=this.N,e=await createImageBitmap(this.file,{colorSpaceConversion:"none"}),n=e.width,i=e.height,o=n*i;this.$=o;try{let t=new OffscreenCanvas(n,i);const o=t.getContext("2d",{willReadFrequently:!0});o.imageSmoothingEnabled=!1,o.clearRect(0,0,n,i),o.drawImage(e,0,0);const s=o.getImageData(0,0,n,i).data;p(t),t=null;let r=0,a=0;const c=new Map;for(let t=0;t<i;t++)for(let e=0;e<n;e++){const i=4*(t*n+e),o=s[i],l=s[i+1],m=s[i+2];if(0===s[i+3])continue;222===o&&250===l&&206===m&&a++;const u=this.O.has(`${o},${l},${m}`)?`${o},${l},${m}`:"other";r++,c.set(u,(c.get(u)||0)+1)}this.M=r,this.k=a;const l={};for(const[t,e]of c.entries())l[t]={count:e,enabled:!0};this.C=l}catch(t){this.M=Math.max(0,this.$),this.k=0}const s={},r={};let c=new OffscreenCanvas(this.p,this.p);const l=c.getContext("2d",{willReadFrequently:!0});for(let o=this.coords[3];o<i+this.coords[3];){const m=Math.min(this.p-o%this.p,i+this.coords[3]-o);for(let i=this.coords[2];i<n+this.coords[2];){const u=Math.min(this.p-i%this.p,n+this.coords[2]-i),d=u*t,h=m*t;c.width=d,c.height=h,l.imageSmoothingEnabled=!1,l.clearRect(0,0,d,h),l.drawImage(e,i-this.coords[2],o-this.coords[3],u,m,0,0,u*t,m*t);const b=l.getImageData(0,0,d,h);for(let e=0;e<h;e++)for(let n=0;n<d;n++){const i=4*(e*d+n);222===b.data[i]&&250===b.data[i+1]&&206===b.data[i+2]?((n+e)%2==0?(b.data[i]=0,b.data[i+1]=0,b.data[i+2]=0):(b.data[i]=255,b.data[i+1]=255,b.data[i+2]=255),b.data[i+3]=32):this.S(n,e,t)||(b.data[i+3]=0)}l.putImageData(b,0,0);const p=`${(this.coords[0]+Math.floor(i/1e3)).toString().padStart(4,"0")},${(this.coords[1]+Math.floor(o/1e3)).toString().padStart(4,"0")},${(i%1e3).toString().padStart(3,"0")},${(o%1e3).toString().padStart(3,"0")}`;s[p]=await createImageBitmap(c),this.T.add(p.split(",").slice(0,2).join(","));const f=await c.convertToBlob(),g=await f.arrayBuffer(),w=Array.from(new Uint8Array(g));r[p]=a(w),i+=u}o+=m}return p(c),c=null,{F:s,P:r}}};w=new WeakSet,y=async function(t){const e=t.templates;if(Object.keys(e).length>0){for(const t in e){const n=t,i=e[t],o=i.coords.split(",").map(Number);if(e.hasOwnProperty(t)){const t=n.split(" "),s=Number(t?.[0]),r=t?.[1]||"0",a=i.name||`Template ${s||""}`,l=i.tiles,m={};let u=0;const d=new Map;for(const t in l)if(l.hasOwnProperty(t)){const i=c(l[t]),o=new Blob([i],{type:"image/png"}),s=await createImageBitmap(o);m[t]=s;try{const t=s.width,i=s.height;let o=new OffscreenCanvas(t,i);const r=o.getContext("2d",{willReadFrequently:!0});r.imageSmoothingEnabled=!1,r.clearRect(0,0,t,i),r.drawImage(s,0,0);const a=r.getImageData(0,0,t,i).data;p(o),o=null;for(let o=this.G;o<i;o+=this.A)for(let i=this.G;i<t;i+=this.A){const s=4*(o*t+i),r=a[s],c=a[s+1],l=a[s+2];if(a[s+3]<64)continue;if(222===r&&250===c&&206===l)continue;u++;const m=Object.hasOwn(e[n].palette,`${r},${c},${l}`)?`${r},${c},${l}`:"other";d.set(m,(d.get(m)||0)+1)}}catch(t){}}const h=new k({displayName:a,m:s||this.R?.length||0,u:r||"",coords:o});h.N=this.A,h.h=m,h.M=u,h.enabled=i.enabled??!0;const b={};for(const[t,e]of d.entries())b[t]={count:e,enabled:!0};h.C=b;try{Object.keys(m).forEach(t=>{h.T?.add(t.split(",").slice(0,2).join(","))})}catch(t){}try{const t=e?.[n]?.palette;if(t)for(const[e,n]of Object.entries(t))h.C[e]?h.C[e].enabled=!!n?.enabled:h.C[e]={count:n?.count||0,enabled:!!n?.enabled}}catch(t){}h.D=n,this.R.push(h)}}try{const t=document.querySelector("#bm-8");t&&(t.style.display=""),window.postMessage({source:"blue-marble",q:"bm-b"},"*")}catch(t){}try{const t=document.querySelector("#bm-5");t&&(t.style.display=""),window.postMessage({source:"blue-marble",q:"bm-7"},"*")}catch(t){}}},v=new WeakSet,$=function(t){o(this,v,x).call(this,t),this.H=setInterval(()=>{o(this,v,x).call(this,t)},1e3)},x=function(t){if(null===this.charges)return void o(this,v,M).call(this);const e=Math.floor(this.U()),n=this.charges.max,i=`<span style="color: lightgray; font-size: 0.8em;">(${(new Intl.NumberFormat).format(e)} / ${(new Intl.NumberFormat).format(n)})</span>`,s=`<b style="color: orange">${this.Y()}</b>`;t.W("bm-t",`Full Charges in ${s} ${i}`)},M=function(){const t=document.querySelector(".relative>.dropdown>.dropdown-content>section>button.btn");if(null!==t)if(void 0!==t.__click)t.__click[2].user.refresh();else{const t=()=>{document.querySelector(".relative>.dropdown>.dropdown-content>section>button.btn").__click[2].user.refresh()},e=document.createElement("script");e.textContent=`(${t})();`,document.documentElement?.appendChild(e),e.remove()}};var C=GM_info.script.name.toString(),T=GM_info.script.version.toString();!function(t){const e=document.createElement("script");e.setAttribute("bm-H",C),e.setAttribute("bm-E","color: cornflowerblue;"),e.textContent=`(${t})();`,document.documentElement?.appendChild(e),e.remove()}(()=>{const t=document.currentScript,e=t?.getAttribute("bm-H")||"Blue Marble",n=t?.getAttribute("bm-E")||"",i=new Map;window.addEventListener("message",t=>{const{source:o,endpoint:s,blobID:r,blobData:a,blink:c}=t.data;if(Date.now(),"blue-marble"==o&&r&&a&&!s){const t=i.get(r);"function"==typeof t?t(a):function(...t){(0,console.warn)(...t)}(`%c${e}%c: Attempted to retrieve a blob (%s) from queue, but the blobID was not a function! Skipping...`,n,"",r),i.delete(r)}});const o=window.fetch;window.fetch=async function(...t){const e=await o.apply(this,t),n=e.clone(),s=(t[0]instanceof Request?t[0]?.url:t[0])||"ignore",r=n.headers.get("content-type")||"";if(r.includes("application/json")){const t=Date.now();n.json().then(e=>{window.postMessage({source:"blue-marble",endpoint:s,jsonData:e,blink:t},"*")}).catch(t=>{})}else if(r.includes("image/")&&!s.includes("openfreemap")&&!s.includes("maps")){const t=Date.now(),e=await n.blob();return new Promise(o=>{const r=crypto.randomUUID();i.set(r,t=>{o(new Response(t,{headers:n.headers,status:n.status,statusText:n.statusText}))}),window.postMessage({source:"blue-marble",endpoint:s,lastModified:n.headers.get("Last-Modified"),blobID:r,blobData:e,blink:t})}).catch(t=>{Date.now()})}return e}}),GM.addStyle("#bm-D{position:fixed;background-color:#153063cc;color:#fff;padding:10px;border-radius:8px;z-index:9000;transition:all .3s ease,transform 0s;max-width:300px;width:auto;will-change:transform;backface-visibility:hidden;-webkit-backface-visibility:hidden;transform-style:preserve-3d;-webkit-transform-style:preserve-3d}#bm-d,#bm-D hr,#bm-c,#bm-6{transition:opacity .2s ease,height .2s ease}div#bm-D{font-family:ui-sans-serif,system-ui,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Monaco,DejaVu Sans,sans-serif;letter-spacing:.05em}#bm-C{margin-bottom:.5em;background:url('data:image/svg+xml;utf8,<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"5\" height=\"5\"><circle cx=\"3\" cy=\"3\" r=\"1.5\" fill=\"CornflowerBlue\" /></svg>') repeat;cursor:grab;width:100%;height:1em}#bm-C.dragging{cursor:grabbing}#bm-D:has(#bm-C.dragging){pointer-events:none;user-select:none;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none}#bm-C.dragging{pointer-events:auto}#bm-j{margin-bottom:.5em}#bm-j[style*=\"text-align: center\"]{display:flex;flex-direction:column;align-items:center;justify-content:center}#bm-D[style*=\"padding: 5px\"]{width:auto!important;max-width:300px;min-width:200px}#bm-D img{display:inline-block;height:2.5em;margin-right:1ch;vertical-align:middle;transition:opacity .2s ease}#bm-j[style*=\"text-align: center\"] img{display:block;margin:0 auto}#bm-C{transition:margin-bottom .2s ease}#bm-D h1{display:inline-block;font-size:x-large;font-weight:700;vertical-align:middle}#bm-c input[type=checkbox]{vertical-align:middle;margin-right:.5ch}#bm-c label{margin-right:.5ch}.bm-I{border:white 1px solid;height:1.5em;width:1.5em;margin-top:2px;text-align:center;line-height:1em;padding:0!important}#bm-q{vertical-align:middle}#bm-q svg{width:50%;margin:0 auto;fill:#111}div:has(>#bm-g){display:flex;gap:.5ch}#bm-button-favorite svg,#bm-button-template svg{height:1em;margin:2px auto 0;text-align:center;line-height:1em;vertical-align:bottom}#bm-k input[type=number]{appearance:auto;-moz-appearance:textfield;width:5.5ch;margin-left:1ch;background-color:#0003;padding:0 .5ch;font-size:small}#bm-k input[type=number]::-webkit-outer-spin-button,#bm-k input[type=number]::-webkit-inner-spin-button{-webkit-appearance:none;margin:0}#bm-3,#bm-4{display:flex;flex-direction:row;flex-wrap:wrap;align-content:center;justify-content:center;align-items:center;gap:1ch}div:has(>#bm-9)>button{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}#bm-9,input[type=file][id*=template]{display:none!important;visibility:hidden!important;position:absolute!important;left:-9999px!important;top:-9999px!important;width:0!important;height:0!important;opacity:0!important;z-index:-9999!important;pointer-events:none!important}#bm-o{font-size:small;background-color:#0003;padding:0 .5ch;height:3.75em;width:100%}#bm-6{display:flex;justify-content:space-between}#bm-D small{font-size:x-small;color:#d3d3d3}#bm-d,#bm-c,#bm-k,#bm-3,#bm-4,#bm-o{margin-top:.5em}#bm-D button{background-color:#144eb9;border-radius:1em;padding:0 .75ch}#bm-D button:hover,#bm-D button:focus-visible{background-color:#1061e5}#bm-D button:active #bm-D button:disabled{background-color:#2e97ff}#bm-D button:disabled{text-decoration:line-through}\n");var D=new class{constructor(e,n){i(this,t),this.name=e,this.version=n,this.J=null,this.X="bm-o",this.i=null,this.o=null,this.l=[]}_(t){this.J=t}V(){return this.l.length>0&&(this.o=this.l.pop()),this}K(t){t?.appendChild(this.i),this.i=null,this.o=null,this.l=[]}Z(n={},i=()=>{}){return i(this,o(this,t,e).call(this,"div",{},n)),this}tt(n={},i=()=>{}){return i(this,o(this,t,e).call(this,"p",{},n)),this}et(n={},i=()=>{}){return i(this,o(this,t,e).call(this,"small",{},n)),this}nt(n={},i=()=>{}){return i(this,o(this,t,e).call(this,"img",{},n)),this}it(n,i={},s=()=>{}){return s(this,o(this,t,e).call(this,"h"+n,{},i)),this}ot(n={},i=()=>{}){return i(this,o(this,t,e).call(this,"hr",{},n)),this}st(n={},i=()=>{}){return i(this,o(this,t,e).call(this,"br",{},n)),this}rt(n={},i=()=>{}){const s=o(this,t,e).call(this,"label",{textContent:n.textContent??""});delete n.textContent;const r=o(this,t,e).call(this,"input",{type:"checkbox"},n);return s.insertBefore(r,s.firstChild),this.V(),i(this,s,r),this}ct(n={},i=()=>{}){return i(this,o(this,t,e).call(this,"button",{},n)),this}lt(n={},i=()=>{}){const s=n.title??n.textContent??"Help: No info";delete n.textContent,n.title=`Help: ${s}`;const r={textContent:"?",className:"bm-I",onclick:()=>{this.W(this.X,s)}};return i(this,o(this,t,e).call(this,"button",r,n)),this}ut(n={},i=()=>{}){return i(this,o(this,t,e).call(this,"input",{},n)),this}dt(n={},i=()=>{}){const s=n.textContent??"";delete n.textContent;const r=o(this,t,e).call(this,"span"),a=o(this,t,e).call(this,"input",{type:"file",style:"display: none !important; visibility: hidden !important; position: absolute !important; left: -9999px !important; width: 0 !important; height: 0 !important; opacity: 0 !important;"},n);this.V();const c=o(this,t,e).call(this,"button",{textContent:s});return this.V(),this.V(),a.setAttribute("tabindex","-1"),a.setAttribute("aria-hidden","true"),c.addEventListener("click",()=>{a.click()}),a.addEventListener("change",()=>{c.style.maxWidth=`${c.offsetWidth}px`,a.files.length>0?c.textContent=a.files[0].name:c.textContent=s}),i(this,r,a,c),this}ht(n={},i=()=>{}){return i(this,o(this,t,e).call(this,"textarea",{},n)),this}W(t,e,n=!1){const i=document.getElementById(t.replace(/^#/,""));i&&(i instanceof HTMLInputElement?i.value=e:n?i.textContent=e:i.innerHTML=e)}bt(t,e){let n,i=!1,o=0,s=null,r=0,a=0,c=0,l=0;if(t=document.querySelector("#"==t?.[0]?t:"#"+t),e=document.querySelector("#"==e?.[0]?e:"#"+e),!t||!e)return void this.ft(`Can not drag! ${t?"":"moveMe"} ${t||e?"":"and "}${e?"":"iMoveThings "}was not found!`);const m=()=>{if(i){const e=Math.abs(r-c),n=Math.abs(a-l);(e>.5||n>.5)&&(r=c,a=l,t.style.transform=`translate(${r}px, ${a}px)`,t.style.left="0px",t.style.top="0px",t.style.right=""),s=requestAnimationFrame(m)}};let u=null;const d=(d,h)=>{i=!0,u=t.getBoundingClientRect(),n=d-u.left,o=h-u.top;const b=window.getComputedStyle(t).transform;if(b&&"none"!==b){const t=new DOMMatrix(b);r=t.m41,a=t.m42}else r=u.left,a=u.top;c=r,l=a,document.body.style.userSelect="none",e.classList.add("dragging"),s&&cancelAnimationFrame(s),m()},h=()=>{i=!1,s&&(cancelAnimationFrame(s),s=null),document.body.style.userSelect="",e.classList.remove("dragging")};e.addEventListener("mousedown",function(t){t.preventDefault(),d(t.clientX,t.clientY)}),e.addEventListener("touchstart",function(t){const e=t?.touches?.[0];e&&(d(e.clientX,e.clientY),t.preventDefault())},{passive:!1}),document.addEventListener("mousemove",function(t){i&&u&&(c=t.clientX-n,l=t.clientY-o)},{passive:!0}),document.addEventListener("touchmove",function(t){if(i&&u){const e=t?.touches?.[0];if(!e)return;c=e.clientX-n,l=e.clientY-o,t.preventDefault()}},{passive:!1}),document.addEventListener("mouseup",h),document.addEventListener("touchend",h),document.addEventListener("touchcancel",h)}gt(t){(0,console.info)(`${this.name}: ${t}`),this.W(this.X,"Status: "+t,!0)}ft(t){(0,console.error)(`${this.name}: ${t}`),this.W(this.X,"Error: "+t,!0)}}(C,T),O=new class{constructor(t,e,n){i(this,w),this.name=t,this.version=e,this.i=n,this.wt="1.0.0",this.yt=null,this.vt="!#$%&'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[]^_`abcdefghijklmnopqrstuvwxyz{|}~",this.p=1e3;let o=new OffscreenCanvas(5e3,5e3);const s=o.getContext("2d");s.fillRect(4999,4999,1,1),0!==s.getImageData(4999,4999,1,1).data[3]?this.A=5:this.A=4,p(o),o=null,this.G=this.A-1>>1,this.$t=null,this.xt=null,this.Mt="bm-F",this.kt="div#map canvas.maplibregl-canvas",this.Ct=null,this.Tt="",this.R=[],this.Dt=null,this.Ot=!0,this.Lt=new Map,this.extraColorsBitmap=0,this.Nt={},this.hideLockedColors=!1}St(){if(document.body.contains(this.$t))return this.$t;document.getElementById(this.Mt)?.remove();const t=document.querySelector(this.kt),e=document.createElement("canvas");return e.id=this.Mt,e.className="maplibregl-canvas",e.style.position="absolute",e.style.top="0",e.style.left="0",e.style.height=t?.clientHeight*(window.devicePixelRatio||1)+"px",e.style.width=t?.clientWidth*(window.devicePixelRatio||1)+"px",e.height=t?.clientHeight*(window.devicePixelRatio||1),e.width=t?.clientWidth*(window.devicePixelRatio||1),e.style.zIndex="8999",e.style.pointerEvents="none",t?.parentElement?.appendChild(e),this.$t=e,window.addEventListener("move",this.It),window.addEventListener("zoom",this.Bt),window.addEventListener("resize",this.jt),this.$t}async Ft(){return{whoami:this.name.replace(" ",""),scriptVersion:this.version,schemaVersion:this.wt,templates:{}}}async Pt(t,e,n){this.Dt||(this.Dt=await this.Ft()),this.i.gt(`Creating template at ${n.join(", ")}...`);const i=new k({displayName:e,m:Object.keys(this.Dt.templates).length||0,u:r(this.yt||0,this.vt),file:t,coords:n});i.N=this.A;const{F:o,P:s}=await i.j(this.p),a=this.Et();for(const t of Object.keys(i.C))void 0!==a[t]&&(i.C[t].enabled=a[t]);i.h=o;const c=`${i.m} ${i.u}`;i.D=c,this.Dt.templates[c]={name:i.displayName,coords:n.join(", "),enabled:!0,tiles:s,palette:i.C},this.R.push(i),this.Gt(i);const l=(new Intl.NumberFormat).format(i.$);this.i.gt(`Template created at ${n.join(", ")}! Total pixels: ${l}`),this.At(),await this.Rt()}At(){try{const t=document.querySelector("#bm-8");t&&(t.style.display=""),window.postMessage({source:"blue-marble",q:"bm-b"},"*")}catch(t){}try{const t=document.querySelector("#bm-5");t&&(t.style.display=""),window.postMessage({source:"blue-marble",q:"bm-7"},"*")}catch(t){}}async Rt(){await GM.setValue("bmTemplates",JSON.stringify(this.Dt))}async zt(t){const e=this.R.find(e=>e.D===t);if(void 0===e)return;const n=this.R.indexOf(e);this.R.splice(n,1);const i=this.Dt?.templates;i&&i?.[t]&&delete i[t],this.Gt(e),this.i.gt(`Template ${e.displayName} is deleted!`),await this.Rt(),this.At()}async qt(){this.Dt||(this.Dt=await this.Ft())}async Ht(t,e){if(!this.Ot)return t;const n=this.p*this.A,i=e;e=e[0].toString().padStart(4,"0")+","+e[1].toString().padStart(4,"0");const o=this.R;if(o.sort((t,e)=>t.m-e.m),!o.some(t=>!!t?.h&&(t.T&&t.T.size>0?t.T.has(e):Object.keys(t.h).some(t=>t.startsWith(e)))))return t;const s=o.map(t=>{const n=Object.keys(t.h).filter(t=>t.startsWith(e));if(0===n.length)return null;const i=n.map(e=>{const n=e.split(",");return{Ct:t,D:t.D,Ut:t.h[e],Yt:[n[0],n[1]],Wt:[n[2],n[3]]}});return i?.[0]}).filter(Boolean),r=s?.length||0,a=this.R.filter(t=>t.enabled).length;let c=0,u=0,d=0,b={},f={};const g=await createImageBitmap(t);let w=new OffscreenCanvas(n,n);const y=w.getContext("2d");y.imageSmoothingEnabled=!1,y.beginPath(),y.rect(0,0,n,n),y.clip(),y.clearRect(0,0,n,n),y.drawImage(g,0,0,n,n);let v=null;try{v=y.getImageData(0,0,n,n).data}catch(t){}const $=Object.fromEntries(l.map(t=>{const[e,n,i]=t.rgb;return[`${e},${n},${i}`,t]})),x=this.Et(),M=this.Jt(),k=Object.values(x).some(t=>!1===t)||M,C=Object.values(x).every(t=>!1===t);for(const t of s){const e=t.D;if(v)try{const o=t.Ut.width,s=t.Ut.height;let r=new OffscreenCanvas(o,s);const a=r.getContext("2d",{willReadFrequently:!0});a.imageSmoothingEnabled=!1,a.clearRect(0,0,o,s),a.drawImage(t.Ut,0,0);const l=a.getImageData(0,0,o,s).data;p(r),r=null;const h=Number(t.Wt[0])*this.A,g=Number(t.Wt[1])*this.A;for(let r=this.G;r<s;r+=this.A)for(let s=this.G;s<o;s+=this.A){const a=s+h,p=r+g;if(a<0||p<0||a>=n||p>=n)continue;const w=4*(r*o+s),y=l[w],x=l[w+1],M=l[w+2];if(l[w+3]<64){try{this.R;const t=4*(p*n+a),e=v[t],i=v[t+1],o=v[t+2],s=v[t+3],r=m.has(`${e},${i},${o}`)?`${e},${i},${o}`:"other",c=m.has(r);s>=64&&c&&u++}catch(t){}continue}d++;const k=4*(p*n+a),C=v[k],T=v[k+1],D=v[k+2],O=v[k+3];let L=!1;if(O<64);else if(C===y&&T===x&&D===M){c++,L=!0;let n=`${y},${x},${M}`;void 0===$[n]&&(n="other"),void 0===b[n]?b[n]={Xt:1,_t:+(t.Ct.enabled??!0),Vt:0,Kt:[],Zt:[]}:(b[n].Xt++,(t.Ct.enabled??1)&&b[n]._t++),void 0===f[e]?f[e]={Xt:1}:f[e].Xt++}else u++;if(!L){let e=`${y},${x},${M}`;void 0===$[e]&&(e="other");const n=[i,[Math.floor(a/this.A),Math.floor(p/this.A)]];if(void 0===b[e])b[e]={Xt:0,_t:0,Vt:1,Kt:[n],Zt:[]},(t.Ct.enabled??1)&&b[e].Zt.push(n);else{const i=this.Nt?.smartPlace?1<<20:100;if(b[e].Vt++,b[e].Kt.length<i)b[e].Kt.push(n);else if(Math.random()*b[e].Kt.length<i){const t=Math.floor(Math.random()*i);b[e].Kt[t]=n}if(t.Ct.enabled??1)if(b[e].Zt.length<i)b[e].Zt.push(n);else if(Math.random()*b[e].Zt.length<i){const t=Math.floor(Math.random()*i);b[e].Zt[t]=n}}}}}catch(t){}if(t.Ct.enabled??1)try{const e=Number(t.Wt[0])*this.A,n=Number(t.Wt[1])*this.A;if(k){if(!C){const i=t.Ut.width,o=t.Ut.height;let s=new OffscreenCanvas(i,o);const r=s.getContext("2d",{willReadFrequently:!0});r.imageSmoothingEnabled=!1,r.clearRect(0,0,i,o),r.drawImage(t.Ut,0,0);const a=r.getImageData(0,0,i,o),c=a.data;for(const[e,n]of t.Ct.I(this.A))for(let t=n;t<o;t+=this.A)for(let n=e;n<i;n+=this.A){const e=4*(t*i+n),o=c[e],s=c[e+1],r=c[e+2];if(c[e+3]<1)continue;let a=m.has(`${o},${s},${r}`)?`${o},${s},${r}`:"other";const l=m.has(a),u=!1!==x?.[a],d=M&&("other"===a||h.has(a)&&!this.Qt(h.get(a).id));l&&u&&!d||(c[e+3]=0)}r.putImageData(a,0,0),y.drawImage(s,e,n),p(s),s=null}}else y.drawImage(t.Ut,e,n)}catch(e){y.drawImage(t.Ut,offsetX,offsetY)}}if(r>0){const t=e;this.Lt.set(t,{Xt:c,required:d,te:u,palette:b,Ct:f});let n=0,i=0,o=0;for(const t of this.Lt.values())n+=t.Xt||0,i+=t.required||0,o+=t.te||0;const s=this.R.reduce((t,e)=>t+(e.M||e.$||0),0),r=s>0?s:i,l=(new Intl.NumberFormat).format(n),m=(new Intl.NumberFormat).format(r),h=(new Intl.NumberFormat).format(r-n);this.i.gt(`Displaying ${a} template${1==a?"":"s"}.\nPainted ${l} / ${m} â€¢ Wrong ${h}`)}else this.i.gt(`Displaying ${a} template${1==a?"":"s"}.`);const T=await w.convertToBlob({type:"image/png"});return p(w),w=null,window.buildColorFilterList(),window.buildTemplateFilterList(),T}ee(t){"BlueMarble"==t?.whoami&&(this.Dt=t,o(this,w,y).call(this,t))}ne(t){this.Ot=t}Et(){const t={};for(const e of this.R)for(const[n,i]of Object.entries(e.C))t[n]||(t[n]=i.enabled);return t}async ie(){await GM.setValue("bmUserSettings",JSON.stringify(this.Nt))}oe(t){this.Nt=t}Jt(){return this.Nt?.hideLockedColors??!1}async se(t){this.Nt.hideLockedColors=t,await this.ie()}re(t){this.extraColorsBitmap!==t&&(this.extraColorsBitmap=t,window.buildColorFilterList())}Qt(t){if(t<32)return!0;const e=1<<t-32;return 0!==(this.extraColorsBitmap&e)}Gt(t){t.T.forEach(t=>{this.Lt.delete(t)})}}(C,T,D),L=new class{constructor(t){i(this,v),this.ae=t,this.ce=!1,this.le=[],this.me=[],this.charges=null,this.ue=null,this.H=null,this.de={}}U(){if(null===this.charges)return o(this,v,M).call(this),0;const t=(Date.now()-this.ue)/this.charges.cooldownMs,e=this.charges.count+t,n=this.charges.count>this.charges.max?this.charges.count:this.charges.max;return e>n?n:e}he(){const t=this.U();return t>=this.charges.max?0:(this.charges.max-t)*this.charges.cooldownMs}Y(){const t=this.he();if(0===t)return"00:00";const e=Math.floor(t/1e3),n=Math.floor(e/3600),i=Math.floor(e%3600/60).toString().padStart(2,"0"),o=(e%60).toString().padStart(2,"0");return n>0?`${n}:${i}:${o}`:`${i}:${o}`}be(t){o(this,v,$).call(this,t),window.addEventListener("message",async e=>{const n=e.data,i=n.jsonData;if(!n||"blue-marble"!==n.source)return;if(!n.endpoint)return;const o=n.endpoint?.split("?")[0].split("/").filter(t=>t&&isNaN(Number(t))).filter(t=>t&&!t.includes(".")).pop();switch(o){case"me":if(i.status&&"2"!=i.status?.toString()[0])return void(i.fallback||t.ft("You are not logged in!\nCould not fetch userdata."));const e=Math.ceil(Math.pow(Math.floor(i.level)*Math.pow(30,.65),1/.65)-i.pixelsPainted);i.id||i.id,this.ae.yt=i.id,this.charges=i.charges,this.ue=Date.now(),this.ae.re(i.extraColorsBitmap??0),t.W("bm-w",`Username: <b>${function(t){const e=document.createElement("div");return e.textContent=t,e.innerHTML}(i.name)}</b>`),t.W("bm-p",`Droplets: <b>${(new Intl.NumberFormat).format(i.droplets)}</b>`),t.W("bm-h",`<b>${(new Intl.NumberFormat).format(e)}</b> more pixel${1==e?"":"s"} to Lv. <b>${Math.floor(i.level)+1}</b>`);break;case"pixel":const o=n.endpoint.split("?")[0].split("/").filter(t=>t&&!isNaN(Number(t))).map(t=>Number(t)),a=new URLSearchParams(n.endpoint.split("?")[1]),c=[+a.get("x"),+a.get("y")];if(this.le.length&&(!o.length||!c.length))return void t.ft("Coordinates are malformed!\nDid you try clicking the canvas first?");this.le=[...o,...c];const l=(s=o,r=c,[parseInt(s[0])%4*1e3+parseInt(r[0]),parseInt(s[1])%4*1e3+parseInt(r[1])]),m=document.querySelectorAll("span");for(const t of m)if(t.textContent.trim().includes(`${l[0]}, ${l[1]}`)){let e=document.querySelector("#bm-i"),n=document.querySelector("#bm-f");const i=b(o,c),s=`(Tl X: ${o[0]}, Tl Y: ${o[1]}, Px X: ${c[0]}, Px Y: ${c[1]})`,r=`(${i[0].toFixed(5)}, ${i[1].toFixed(5)})`;if(e)e.textContent=s,n.textContent=r;else{e=document.createElement("span"),e.id="bm-i",e.textContent=s,e.style="margin-left: calc(var(--spacing)*3); font-size: small;",t.parentNode.parentNode.parentNode.insertAdjacentElement("afterend",e);const i=document.createElement("br");e.insertAdjacentElement("afterend",i),n=document.createElement("span"),n.id="bm-f",n.textContent=r,n.style="margin-left: calc(var(--spacing)*3); font-size: small;",i.insertAdjacentElement("afterend",n)}}break;case"tiles":let u=n.endpoint.split("/");u=[parseInt(u[u.length-2]),parseInt(u[u.length-1].replace(".png",""))];const d=n.blobID,h=n.blobData,p=u[0].toString().padStart(4,"0")+","+u[1].toString().padStart(4,"0"),f=n.lastModified,g=this.ae.Jt()?"1":"0",w=(this.ae.R??[]).map(t=>{const e=t.enabled??!0,n=t.C||{};return`${+e}|${Object.keys(n).filter(t=>!1!==n[t]?.enabled).sort().join(";")}|${Object.keys(t.h||{}).sort().join(";")}`}).join("||")+"||"+g;let y=null;this.de[p]&&this.de[p].lastModified===f&&this.de[p].fullKey===w&&(y=this.de[p].templateBlob),null===y&&(y=await this.ae.Ht(h,u),this.ae.Ot&&this.ae.R.some(t=>!!t?.h&&(t.T&&t.T.size>0?t.T.has(p):Object.keys(t.h).some(t=>t.startsWith(p))))&&(this.de[p]={lastModified:f,fullKey:w,templateBlob:y})),window.postMessage({source:"blue-marble",blobID:d,blobData:y,blink:n.blink});break;case"robots":this.ce="false"==i.userscript?.toString().toLowerCase()}var s,r})}}(O);D._(L),GM.getValue("bmTemplates","{}").then(async t=>{let e;try{e=JSON.parse(t)}catch{e={}}O.ee(e);const n=await GM.getValue("bmUserSettings","{}");let i;try{i=JSON.parse(n)}catch{i={}}if(0==Object.keys(i).length){const t=crypto.randomUUID();O.oe({uuid:t,hideLockedColors:!1,smartPlace:!1}),O.ie()}else O.oe(i);await async function(){let t=!1,e={};const n=await GM.getValue("bmCoords","{}");try{e=JSON.parse(n)||{}}catch{e={}}D.Z({id:"bm-D",style:"top: 10px; right: 75px;"}).Z({id:"bm-j"}).Z({id:"bm-C"}).V().nt({alt:"Blue Marble Icon - Click to minimize/maximize",src:"https://raw.githubusercontent.com/SwingTheVine/Wplace-BlueMarble/main/dist/assets/Favicon.png",style:"cursor: pointer;"},(e,n)=>{n.addEventListener("click",()=>{t=!t;const i=document.querySelector("#bm-D"),o=document.querySelector("#bm-j"),s=document.querySelector("#bm-C"),r=document.querySelector("#bm-k"),a=document.querySelector("#bm-q"),c=document.querySelector("#bm-r"),l=document.querySelector("#bm-s"),m=document.querySelector("#bm-l"),u=document.querySelectorAll("#bm-k input");t||(i.style.width="auto",i.style.maxWidth="300px",i.style.minWidth="200px",i.style.padding="10px"),["#bm-D h1","#bm-d","#bm-D hr","#bm-c > *:not(#bm-k)","#bm-6",`#${e.X}`,"#bm-1","#bm-8","#bm-5"].forEach(e=>{document.querySelectorAll(e).forEach(e=>{e.style.display=t?"none":""})}),t?(r&&(r.style.display="none"),a&&(a.style.display="none"),c&&(c.style.display="none"),l&&(l.style.display="none"),m&&(m.style.display="none"),u.forEach(t=>{t.style.display="none"}),i.style.width="60px",i.style.height="76px",i.style.maxWidth="60px",i.style.minWidth="60px",i.style.padding="8px",n.style.marginLeft="3px",o.style.textAlign="center",o.style.margin="0",o.style.marginBottom="0",s&&(s.style.display="",s.style.marginBottom="0.25em")):(r&&(r.style.display="",r.style.flexDirection="",r.style.justifyContent="",r.style.alignItems="",r.style.gap="",r.style.textAlign="",r.style.margin=""),a&&(a.style.display=""),c&&(c.style.display="",c.style.marginTop=""),l&&(l.style.display="",l.style.marginTop=""),m&&(m.style.display="",m.style.marginTop=""),u.forEach(t=>{t.style.display=""}),n.style.marginLeft="",i.style.padding="10px",o.style.textAlign="",o.style.margin="",o.style.marginBottom="",s&&(s.style.marginBottom="0.5em"),i.style.width="",i.style.height=""),n.alt=t?"Blue Marble Icon - Minimized (Click to maximize)":"Blue Marble Icon - Maximized (Click to minimize)"})}).V().it(1,{textContent:C}).et({textContent:` v${T}`}).V().V().V().ot().V().Z({id:"bm-d"}).tt({id:"bm-w",textContent:"Username:"}).V().tt({id:"bm-t",textContent:"Full Charge in N/A"}).V().tt({id:"bm-p",textContent:"Droplets:"}).V().tt({id:"bm-h",textContent:"N/A more pixels to Lv. N/A"}).V().V().ot().V().Z({id:"bm-c"}).Z({id:"bm-k"}).ct({id:"bm-q",className:"bm-I",style:"margin-top: 0;",innerHTML:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 4 6"><circle cx="2" cy="2" r="2"></circle><path d="M2 6 L3.7 3 L0.3 3 Z"></path><circle cx="2" cy="2" r="0.7" fill="white"></circle></svg></svg>'},(t,e)=>{e.onclick=()=>{const e=t.J?.le;e?.[0]?(t.W("bm-y",e?.[0]||""),t.W("bm-z",e?.[1]||""),t.W("bm-A",e?.[2]||""),t.W("bm-B",e?.[3]||""),N()):t.ft("Coordinates are malformed! Did you try clicking on the canvas first?")}}).V().ut({type:"number",id:"bm-y",placeholder:"Tl X",min:0,max:2047,step:1,required:!0,value:e.tx??""},(t,e)=>{e.addEventListener("paste",t=>{let e=(t.clipboardData||window.clipboardData).getData("text").split(" ").filter(t=>t).map(Number).filter(t=>!isNaN(t));if(4!==e.length)return;let n=(i=document,coords=[],coords.push(i.querySelector("#bm-y")),coords.push(i.querySelector("#bm-z")),coords.push(i.querySelector("#bm-A")),coords.push(i.querySelector("#bm-B")),coords);var i;for(let t=0;t<n.length;t++)n[t].value=e[t];t.preventDefault()});const n=()=>N();e.addEventListener("input",n),e.addEventListener("change",n)}).V().ut({type:"number",id:"bm-z",placeholder:"Tl Y",min:0,max:2047,step:1,required:!0,value:e.ty??""},(t,e)=>{const n=()=>N();e.addEventListener("input",n),e.addEventListener("change",n)}).V().ut({type:"number",id:"bm-A",placeholder:"Px X",min:0,max:2047,step:1,required:!0,value:e.px??""},(t,e)=>{const n=()=>N();e.addEventListener("input",n),e.addEventListener("change",n)}).V().ut({type:"number",id:"bm-B",placeholder:"Px Y",min:0,max:2047,step:1,required:!0,value:e.py??""},(t,e)=>{const n=()=>N();e.addEventListener("input",n),e.addEventListener("change",n)}).V().ct({id:"bm-g",className:"bm-I",style:"margin-top: 0;",innerHTML:"âœˆï¸",title:"Teleport"},(t,e)=>{e.onclick=()=>{S()}}).V().V().Z({id:"bm-4",style:"display: flex; gap: 6px;"}).ct({id:"bm-2",textContent:"Enable All"},(t,e)=>{e.onclick=()=>{O.R.forEach(t=>{t?.C&&Object.values(t.C).forEach(t=>t.enabled=!0)}),syncToggleList(),buildColorFilterList(),t.gt("Enabled all colors")}}).V().ct({id:"bm-0",textContent:"Disable All"},(t,e)=>{e.onclick=()=>{O.R.forEach(t=>{t?.C&&Object.values(t.C).forEach(t=>t.enabled=!1)}),syncToggleList(),buildColorFilterList(),t.gt("Disabled all colors")}}).V().V().rt({id:"bm-1",textContent:"Hide Locked Colors",checked:O.Jt()},(t,e,n)=>{e.style.fontSize="12px",e.style.marginLeft="5px",n.addEventListener("change",()=>{O.se(n.checked),buildColorFilterList(),n.checked?t.gt("Hidden all locked colors."):t.gt("Restored all colors.")})}).V().Z({id:"bm-8",style:"max-height: 125px; overflow: auto; border: 1px solid rgba(255,255,255,0.1); padding: 4px; border-radius: 4px; display: none; resize: vertical;"}).Z({id:"bm-e"}).V().V().Z({id:"bm-3"}).dt({id:"bm-9",textContent:"Upload Template",accept:"image/png, image/jpeg, image/webp, image/bmp, image/gif"}).ct({id:"bm-r",textContent:"Create"},(t,e)=>{e.onclick=()=>{const e=document.querySelector("#bm-9"),n=document.querySelector("#bm-y");if(!n.checkValidity())return n.reportValidity(),void t.ft("Coordinates are malformed! Did you try clicking on the canvas first?");const i=document.querySelector("#bm-z");if(!i.checkValidity())return i.reportValidity(),void t.ft("Coordinates are malformed! Did you try clicking on the canvas first?");const o=document.querySelector("#bm-A");if(!o.checkValidity())return o.reportValidity(),void t.ft("Coordinates are malformed! Did you try clicking on the canvas first?");const s=document.querySelector("#bm-B");if(!s.checkValidity())return s.reportValidity(),void t.ft("Coordinates are malformed! Did you try clicking on the canvas first?");e?.files[0]?(O.Pt(e.files[0],e.files[0]?.name.replace(/\.[^/.]+$/,""),[Number(n.value),Number(i.value),Number(o.value),Number(s.value)]),t.gt("Drew to canvas!")):t.ft("No file selected!")}}).V().V().Z({id:"bm-5",style:"max-height: 125px; overflow: auto; border: 1px solid rgba(255,255,255,0.1); padding: 4px; border-radius: 4px; display: none; resize: vertical;"}).Z({id:"bm-a"}).V().V().ht({id:D.X,placeholder:`Status: Sleeping...\nVersion: ${T}`,readOnly:!0}).V().Z({id:"bm-6"}).Z().ct({id:"bm-m",className:"bm-I",innerHTML:"ðŸŽ¨",title:"Template Color Converter"},(t,e)=>{e.addEventListener("click",()=>{window.open("https://pepoafonso.github.io/color_converter_wplace/","_blank","noopener noreferrer")})}).V().ct({id:"bm-n",className:"bm-I",innerHTML:"ðŸŒ",title:"Official Blue Marble Website"},(t,e)=>{e.addEventListener("click",()=>{window.open("https://bluemarble.camilledaguin.fr/","_blank","noopener noreferrer")})}).V().V().Z({id:"bm-G"}).et({textContent:"by SwingTheVine | Forked by TWY",style:"margin-top: auto;"}).V().V().V().V().K(document.body),window.syncToggleList=function(){try{(O.R??[]).forEach(t=>{const e=t.D;if(e&&O.Dt?.templates?.[e]){const n=O.Dt.templates[e];n.enabled=t.enabled,n.palette=t.C}}),O.Rt()}catch(t){}},window.buildColorFilterList=function(){const t=document.querySelector("#bm-e"),e=O.Et();t.innerHTML="";let n=!1;const i={};if((O.R??[]).forEach(t=>{if(t.enabled&&t?.C){n=!0;for(const[e,n]of Object.entries(t.C))i[e]=(i[e]??0)+n.count}}),!t||!n)return void(t&&(t.innerHTML="<small>No template colors to display.</small>"));const o=Object.entries(i).sort((t,e)=>e[1]-t[1]),s={};for(const t of O.Lt.values())Object.entries(t.palette).forEach(([t,e])=>{void 0===s[t]?(s[t]=Object.fromEntries(Object.entries(e)),s[t].Kt=e.Kt.slice(),s[t].Zt=e.Zt.slice()):(s[t].Xt+=e.Xt,s[t]._t+=e._t,s[t].Vt+=e.Vt,s[t].Kt.push(...e.Kt),s[t].Zt.push(...e.Zt))});for(const[n,i]of o){if(O.Jt()&&"other"===n)continue;let o=document.createElement("div");o.style.display="flex",o.style.alignItems="center",o.style.gap="8px",o.style.margin="4px 0";let r=document.createElement("div");r.style.width="14px",r.style.height="14px",r.style.border="1px solid rgba(255,255,255,0.5)";let a=document.createElement("span");a.style.fontSize="12px";const c=`${i.toLocaleString()}`;let l="",m="";if("other"===n)r.style.background="#888",l="Other",m="other";else if("#deface"===n)r.style.background="#deface",l="Transparent",m="transparent";else{const[t,e,i]=n.split(",").map(Number);r.style.background=`rgb(${t},${e},${i})`;try{const o=(O.R??[]).find(t=>t.L?.has(n))?.L?.get(n);if(o&&"number"==typeof o.id){if(O.Jt()&&!O.Qt(o.id))continue;const n=o?.name||`rgb(${t},${e},${i})`,s=o.premium?"â˜… ":"";l=`#${o.id} ${s}${n}`,m=`${t},${e},${i}`}}catch(t){}}const u=s[m],d=`${(u?._t??0).toLocaleString()}`;a.textContent=`${l} â€¢ ${d} / ${c}`;let h=0;r.addEventListener("click",()=>{if((u?.Zt?.length??0)>0){const t=u.Zt,e=h%t.length;f(t[e][0],t[e][1]),++h}}),(u?.Zt?.length??0)>0&&(r.style.cursor="pointer");const b=document.createElement("input");b.type="checkbox",b.checked=e[n]??!0,b.addEventListener("change",()=>{(O.R??[]).forEach(t=>{t?.C&&void 0!==t.C[n]&&(t.C[n].enabled=b.checked)}),D.gt(`${b.checked?"Enabled":"Disabled"} ${n}`),syncToggleList()}),o.appendChild(b),o.appendChild(r),o.appendChild(a),t.appendChild(o)}},window.buildTemplateFilterList=function(){const t=document.querySelector("#bm-a");if(s(O),0===O.R?.length)return void(t&&(t.innerHTML="<small>No templates to display.</small>"));t.innerHTML="";const e=O.R,n={};for(const t of O.Lt.values())Object.entries(t.Ct).forEach(([t,e])=>{void 0===n[t]?n[t]=Object.fromEntries(Object.entries(e)):n[t].Xt+=e.Xt});for(const i of e){let e=document.createElement("div");e.style.display="flex",e.style.alignItems="center",e.style.gap="8px",e.style.margin="4px 0";let o=document.createElement("a");o.title="Remove template",o.textContent="ðŸ—‘ï¸",o.style.fontSize="12px",o.onclick=()=>{confirm(`Remove template ${i?.displayName}?`)&&O.zt(i?.D)};let s=document.createElement("a");s.title="Teleport to template",s.textContent="âœˆï¸",s.style.fontSize="12px",s.onclick=()=>{f(i.coords.slice(0,2),i.coords.slice(2,4))};let r=document.createElement("span");r.style.fontSize="12px";const a=`${i.M.toLocaleString()}`,c=i.displayName,l=`${(n[i.D]?.Xt??0).toLocaleString()}`;r.textContent=`${c} â€¢ ${l} / ${a}`;const m=document.createElement("input");m.type="checkbox",m.checked=i.enabled,m.addEventListener("change",()=>{i.enabled=m.checked,D.gt(`${m.checked?"Enabled":"Disabled"} ${c}`),m.checked||O.Gt(i),syncToggleList()}),e.appendChild(m),e.appendChild(o),e.appendChild(r),e.appendChild(s),t.appendChild(e)}},window.addEventListener("message",t=>{if("bm-b"===t?.data?.q)try{buildColorFilterList()}catch(t){}else if("bm-7"===t?.data?.q)try{buildTemplateFilterList()}catch(t){}}),setTimeout(()=>{try{if(O.R?.length>0){const t=document.querySelector("#bm-8");t&&(t.style.display=""),buildColorFilterList()}if(O.R?.length>0){const t=document.querySelector("#bm-5");t&&(t.style.display=""),buildTemplateFilterList()}}catch(t){}},0)}(),D.bt("#bm-D","#bm-C"),L.be(D),new MutationObserver((t,e)=>{const n=document.querySelector("#color-1");if(!n)return;let i=document.querySelector("#bm-v");if(!i){i=document.createElement("button"),i.id="bm-v",i.textContent="Move â†‘",i.className="btn btn-soft",i.onclick=function(){const t=this.parentNode.parentNode.parentNode.parentNode,e="Move â†‘"==this.textContent;t.parentNode.className=t.parentNode.className.replace(e?"bottom":"top",e?"top":"bottom"),t.style.borderTopLeftRadius=e?"0px":"var(--radius-box)",t.style.borderTopRightRadius=e?"0px":"var(--radius-box)",t.style.borderBottomLeftRadius=e?"var(--radius-box)":"0px",t.style.borderBottomRightRadius=e?"var(--radius-box)":"0px",this.textContent=e?"Move â†“":"Move â†‘"};const t=n.parentNode.parentNode.parentNode.parentNode.querySelector("h2");t.parentNode?.appendChild(i)}if(O.Nt?.smartPlace){let t=document.querySelector("#bm-u");if(!t){t=document.createElement("button"),t.id="bm-u",t.textContent="Paint",t.className="btn btn-soft",t.onclick=function(){const t=Math.floor(L.U());let e=[];const n=O.Et();for(const t of O.Lt.values())Object.entries(t.palette).forEach(([t,i])=>{if(!h.has(t))return;if(!n?.[t])return;const o=h.get(t).id;O.Qt(o)&&e.push(...i.Zt.map(t=>[o,t]))});let i;if(0===e.length)return;try{const t=function(){const t=document.querySelector(".right-3>button");if(null!==t){if(void 0!==t.__click){const e=t.__click[3].v.transform.center;return[e.lat,e.lng]}{const t=()=>{const t=document.currentScript,e=document.querySelector(".right-3>button").__click[3].v.transform.center;t.setAttribute("bm-J",e.lat),t.setAttribute("bm-K",e.lng)},e=document.createElement("script");e.textContent=`(${t})();`,document.documentElement?.appendChild(e);const n=[+e.getAttribute("bm-J"),+e.getAttribute("bm-K")];return e.remove(),n}}throw Error('Could not find the "My location" button.')}(),e=function(t,e){const n=(e+180)/360,i=(Math.log(Math.tan((90+t)*Math.PI/360))/Math.PI+1)/2,o=Math.floor(2048*n*1e3),s=Math.floor(2048*(1-i)*1e3);return[[Math.floor(o/1e3),Math.floor(s/1e3)],[o%1e3,s%1e3]]}(t[0],t[1]);i=[e[0][0]*O.p+e[1][0],e[0][1]*O.p+e[1][1]]}catch{const t=e[Math.floor(Math.random()*e.length)][1];i=[t[0][0]*O.p+t[1][0],t[0][1]*O.p+t[1][1]]}if(e.length<=t);else if(e.length<5e4)e=e.sort(([t,e],[n,o])=>{const s=[e[0][0]*O.p+e[1][0],e[0][1]*O.p+e[1][1]],r=[o[0][0]*O.p+o[1][0],o[0][1]*O.p+o[1][1]];return Math.sqrt(Math.pow(s[0]-i[0],2)+Math.pow(s[1]-i[1],2))*(1+.2*Math.random())-Math.sqrt(Math.pow(r[0]-i[0],2)+Math.pow(r[1]-i[1],2))*(1+.2*Math.random())}).slice(0,t);else{const n={},o=[];e.forEach(([t,e])=>{const o=[e[0][0]*O.p+e[1][0],e[0][1]*O.p+e[1][1]],s=Math.floor(Math.sqrt(Math.pow(o[0]-i[0],2)+Math.pow(o[1]-i[1],2))*(1+.2*Math.random()));void 0===n[s]?n[s]=[[t,e]]:n[s].push([t,e])});const s=Object.keys(n).sort((t,e)=>t-e);for(const e of s)if(o.push(...n[e]),o.length>=t)break;e=o.slice(0,t)}const o=document.querySelector("canvas.maplibregl-canvas");for(let t=0;t<e.length;t++){const[n,i]=e[t];document.getElementById("color-"+n).click(),f(i[0],i[1],!1);const s=new MouseEvent("click",{bubbles:!0,cancelable:!0,clientX:o.offsetWidth/2,clientY:o.offsetHeight/2,button:0});o.dispatchEvent(s)}f(e[0][1][0],e[0][1][1],!1)};const e=n.parentNode.parentNode.parentNode.parentNode.querySelector("h2");e.parentNode?.appendChild(t)}}}).observe(document.body,{childList:!0,subtree:!0}),s(`%c${C}%c (${T}) userscript has loaded!`,"color: cornflowerblue;","")});var N=()=>{try{const[[t,e],[n,i]]=g(),o={tx:t,ty:e,px:n,py:i};GM.setValue("bmCoords",JSON.stringify(o))}catch(t){}},S=()=>{try{const[[t,e],[n,i]]=g();f([t,e],[n,i])}catch(t){}}})();